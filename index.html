<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Arbre de d√©cision ‚Äî Offres commerciales (MATERIEL-LEVAGE)</title>
  <style>
    :root { --b:#e5e7eb; --t:#111827; --m:#6b7280; --bg:#ffffff; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; color: var(--t); background: var(--bg); }
    .wrap { max-width: 860px; margin: 0 auto; }
    .card { border: 1px solid var(--b); border-radius: 14px; padding: 14px; }
    .top { display:flex; align-items:flex-start; justify-content:space-between; gap: 10px; flex-wrap: wrap; }
    .badge { display:inline-block; padding: 4px 10px; border-radius: 999px; border:1px solid var(--b); font-size: 12px; }
    h1 { font-size: 18px; margin: 10px 0 6px; }
    .sub { color: var(--m); font-size: 13px; }
    .divider { height: 1px; background: var(--b); margin: 12px 0; }
    .stepTitle { font-weight: 800; margin: 0 0 4px; }
    .stepDesc { color: var(--m); font-size: 13px; margin: 0 0 10px; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #d1d5db; background: white; cursor: pointer; }
    button:hover { border-color: #9ca3af; }
    button.primary { border-color:#111827; font-weight:700; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr; } }
    .field { border:1px solid var(--b); border-radius: 12px; padding: 10px; margin-top: 10px; }
    label { font-size: 12px; color: var(--m); display:block; margin-bottom: 6px; }
    input[type="number"]{ width: 100%; padding: 10px; border-radius: 10px; border:1px solid #d1d5db; }
    input[type="checkbox"]{ transform: translateY(1px); }
    .chk { display:flex; align-items:flex-start; gap:8px; font-size: 13px; color: var(--t); }
    .result { display:none; border:1px solid var(--b); border-radius: 14px; padding: 12px; background:#fafafa; }
    .result h2 { margin: 0 0 8px; font-size: 16px; }
    .kvs { display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
    .kv { border:1px solid var(--b); border-radius: 12px; padding: 10px; background:white; }
    .kv .k { color: var(--m); font-size: 12px; margin-bottom: 4px; }
    .kv .v { font-weight: 800; }
    .note { margin-top: 10px; color: #374151; font-size: 13px; }
    .small { font-size: 12px; color: var(--m); margin-top: 6px; }
    .pill { display:inline-block; padding: 2px 8px; border:1px solid var(--b); border-radius: 999px; font-size: 12px; margin-left: 6px; color: #374151;}
    .warn { color: #7c2d12; }
    .ok { color: #065f46; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <span class="badge">MATERIEL-LEVAGE</span>
          <h1>üå≥ Arbre de d√©cision ‚Äî Priorisation des offres</h1>
          <div class="sub">Objectif : r√©pondre vite et juste, et solliciter le support manag√©rial au plus juste.</div>
          <div class="small">R√®gle terrain : si tu h√©sites entre deux niveaux, choisis le plus haut.</div>
        </div>
        <div class="badge">SLA : N0 &lt;24h ¬∑ N1 &lt;48h ¬∑ N2 48‚Äì72h ¬∑ N3 4‚Äì5j ¬∑ N4 = pas de r√©ponse</div>
      </div>

      <div class="divider"></div>

      <div id="step">
        <div class="stepTitle" id="stepTitle"></div>
        <div class="stepDesc" id="stepDesc"></div>

        <div id="inputs"></div>
        <div class="row" id="choices"></div>
      </div>

      <div class="result" id="result"></div>
    </div>
  </div>

<script>
const SLA = {
  N0:"< 24 h",
  N1:"< 48 h",
  N2:"48‚Äì72 h",
  N3:"4‚Äì5 jours ouvr√©s",
  N4:"Pas de r√©ponse"
};

// productType:
// - "catalogue_std" : produit catalogue ma√Ætris√©
// - "catalogue_adapte" : produit catalogue adapt√© (vigilance+)
// - "catalogue_assoc" : association/int√©gration produits catalogue (vigilance++)
// - "hors_catalogue" : hors catalogue (nouveau risque)
const S = {
  rating: null,  // A..F
  q: null,       // Q1..Q3
  urgent: null,  // true/false
  stock: null,   // true/false

  productType: null,
  supplierMastered: null, // true/false
  supplierNew: false,     // checkbox √† l‚Äô√©tape 5

  validationOK: null,     // true/false
  doubtReg: false,        // checkbox

  amount: null,           // ‚Ç¨
  margin: null            // %
};

function el(id){ return document.getElementById(id); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function resetAll(){
  S.rating=null; S.q=null; S.urgent=null;
  S.stock=null;
  S.productType=null;
  S.supplierMastered=null;
  S.supplierNew=false;
  S.validationOK=null; S.doubtReg=false;
  S.amount=null; S.margin=null;
  renderNode("rating");
}

function setStep(title, desc){
  el("stepTitle").textContent = title;
  el("stepDesc").textContent = desc;
  el("choices").innerHTML = "";
  el("inputs").innerHTML = "";
  el("result").style.display = "none";
}
function addBtn(label, onClick, primary=false){
  const b = document.createElement("button");
  b.textContent = label;
  if (primary) b.classList.add("primary");
  b.onclick = onClick;
  el("choices").appendChild(b);
}
function addInputHTML(html){
  const d = document.createElement("div");
  d.innerHTML = html;
  el("inputs").appendChild(d);
}

/** D√©clencheurs N4 (pas de r√©ponse) */
function isLevel4Triggered(){
  if (S.rating === "F") return true;
  if (S.q === "Q3" && (S.rating === "D" || S.rating === "E")) return true;
  return false;
}

function computeDecision(){
  // ---- N4 : pas de r√©ponse (r√©sultat imm√©diat) ----
  if (S.rating === "F"){
    return {
      level:"N4", sla:SLA.N4,
      priority:"‚ö´ D√©cision : pas de r√©ponse",
      management:"‚úÖ Obligatoire (arbitrage / blocage)",
      action:"Ne pas produire de devis/offre. Escalader : d√©cision manag√©riale sur reprise commerciale (conditions, gel, ou refus).",
      warnings:["Client F : retard >45 jours ‚Üí pas de r√©ponse commerciale sans arbitrage."],
      note:"Objectif : prot√©ger l‚Äôentreprise et pr√©server la cr√©dibilit√© commerciale."
    };
  }
  if (S.q === "Q3" && S.rating === "D"){
    return {
      level:"N4", sla:SLA.N4,
      priority:"‚ö´ D√©cision : pas de r√©ponse",
      management:"‚ùå Non (sauf exception valid√©e)",
      action:"Ne pas produire de devis d√©taill√©. Qualification obligatoire : infos + √©ch√©ance + d√©cisionnaire. R√©pondre uniquement par cadrage/qualification si engagement client.",
      warnings:["Client D + demande Q3 : faible valeur ‚Üí pas de r√©ponse chiffr√©e."],
      note:"Objectif : prot√©ger le temps commercial et concentrer l‚Äôeffort sur les opportunit√©s transformables."
    };
  }
  if (S.q === "Q3" && S.rating === "E"){
    return {
      level:"N4", sla:SLA.N4,
      priority:"‚ö´ D√©cision : pas de r√©ponse",
      management:"‚úÖ Oui (s√©curisation paiement si reprise)",
      action:"Ne pas produire de devis/offre. Traiter d‚Äôabord le paiement (r√©gularisation). Si reprise : conditions renforc√©es avant action.",
      warnings:["Client E + demande Q3 : retard + demande faible ‚Üí pas de r√©ponse, s√©curisation en amont."],
      note:"Objectif : limiter l‚Äôexposition et revenir sur une base saine."
    };
  }

  const warnings = [];
  const triggers = [];

  // Paiement E : on s√©curise
  if (S.rating === "E"){
    triggers.push("Client E : retard >20 jours (s√©curisation paiement)");
    warnings.push("Client E : s√©curiser paiement avant engagement logistique.");
  }

  // Filtre D : qualification avant devis d√©taill√©
  const isFilterD = (S.rating === "D");
  if (isFilterD){
    warnings.push("Client D : qualification obligatoire avant devis d√©taill√© (√©viter consommation de devis).");
  }

  // Capacit√© de r√©ponse (R)
  // Important : stock => produit catalogue standard + fournisseur ma√Ætris√©
  let R = "R3";
  if (S.stock === true) R = "R1";
  else {
    // catalogue_std -> plut√¥t R2 si fournisseur ma√Ætris√©
    // catalogue_adapte / catalogue_assoc -> toujours R2 mais d√©lai plus long (N2)
    // hors_catalogue -> R3
    if (S.productType === "hors_catalogue") R = "R3";
    else if (S.supplierMastered === true) R = "R2";
    else R = "R3";
  }

  // Priorit√© (matrice Q x R)
  let priority = "üü° Priorit√© normale";
  if (S.q === "Q1" && R === "R1") priority = "üî¥ Priorit√© max";
  else if (S.q === "Q1" && R === "R2") priority = "üü† Priorit√© haute";
  else if (S.q === "Q1" && R === "R3") priority = "üü° Priorit√© ajust√©e";
  else if (S.q === "Q2" && R === "R1") priority = "üü† Priorit√© haute";
  else if (S.q === "Q2" && R === "R2") priority = "üü° Priorit√© normale";
  else if (S.q === "Q2" && R === "R3") priority = "üîµ Priorit√© basse";
  else if (S.q === "Q3" && R === "R1") priority = "üü° Priorit√© normale";
  else if (S.q === "Q3" && R === "R2") priority = "üîµ Priorit√© basse";
  else if (S.q === "Q3" && R === "R3") priority = "‚ö´ Priorit√© tr√®s faible";

  // Niveau (N1/N2/N3) : logique produit + incertitude
  let level = "N1";

  // Stock => N1 rapide
  if (S.stock === true) level = "N1";

  // Catalogue standard (non stock) => N1 ; mais adapt√©/association => N2 (d√©lai plus long)
  if (S.stock === false){
    if (S.productType === "catalogue_std") level = "N1";
    if (S.productType === "catalogue_adapte" || S.productType === "catalogue_assoc") level = "N2";
    if (S.productType === "hors_catalogue") level = "N2";
    if (R === "R3" && S.q === "Q3") level = "N3";
  }

  // Validation technique/r√©glementaire
  if (S.validationOK === false || S.doubtReg === true){
    triggers.push("Validation technique/r√©glementaire non acquise (doute ou validation impossible)");
    warnings.push("Doute technique/r√©glementaire : solliciter support pour s√©curiser l‚Äôad√©quation au besoin.");
    if (level === "N1") level = "N2";
  }

  // Fournisseur : nouveau fournisseur (m√™mes impacts qu‚Äôavant)
  // Si nouveau fournisseur coch√© => consid√©r√© non ma√Ætris√© (m√™me si bouton 'ma√Ætris√©' cliqu√© par erreur)
  if (S.supplierNew === true){
    if (typeof S.amount === "number" && S.amount > 1000){
      triggers.push("Nouveau fournisseur + dossier > 1 000 ‚Ç¨");
    } else {
      warnings.push("Nouveau fournisseur : vigilance (seuil management > 1 000 ‚Ç¨).");
    }
    // On force une lecture prudente
    warnings.push("Nouveau fournisseur : s√©curiser d√©lai/prix/logistique avant promesse.");
  }

  // Hors catalogue + fournisseur non ma√Ætris√©
  if (S.productType === "hors_catalogue" && S.supplierMastered === false){
    triggers.push("Produit hors catalogue + fournisseur non ma√Ætris√©");
    warnings.push("Hors catalogue + fournisseur non ma√Ætris√© : s√©curiser d√©lais/prix/logistique avant promesse.");
    level = (level === "N3") ? "N3" : "N2";
  }

  // Crit√®res financiers (page 7)
  if (typeof S.margin === "number" && typeof S.amount === "number"){
    if (S.margin < 22 && S.amount >= 5000){
      triggers.push("Marge < 22% sur dossier ‚â• 5 000 ‚Ç¨ (arbitrage)");
      if (level === "N1") level = "N2";
    }
  }

  // SLA (d√©lai cible) ajust√© selon type produit
  let sla = SLA[level];

  if (level === "N1"){
    // stock => <24, catalogue standard => <48
    sla = (S.stock === true) ? "< 24 h (cible)" : "< 48 h (cible)";
  }

  if (level === "N2"){
    // catalogue adapt√© / association : 48‚Äì72
    if (S.productType === "catalogue_adapte" || S.productType === "catalogue_assoc"){
      sla = "48‚Äì72 h (cible)";
    }
    // hors catalogue : 3‚Äì5 selon ma√Ætrise
    if (S.productType === "hors_catalogue"){
      sla = (S.supplierMastered === true && S.supplierNew === false) ? "3 jours (cible)" : "3‚Äì5 jours (cible)";
    }
  }

  if (level === "N3"){
    sla = "4‚Äì5 jours ouvr√©s (cible)";
  }

  // Action recommand√©e
  let action = "Produire une offre coh√©rente (besoin ‚Üí solution), avec d√©lai r√©aliste.";
  if (isFilterD){
    action = "Qualifier avant devis d√©taill√© : infos + √©ch√©ance + d√©cisionnaire. Proposer cadrage/fiche de sp√©cification.";
  }
  if (S.rating === "E"){
    action = "S√©curiser conditions de paiement avant engagement (r√©gularisation / conditions renforc√©es).";
  }

  // Notes type produit (valeur p√©dagogique)
  if (S.productType === "catalogue_adapte"){
    warnings.push("Produit catalogue adapt√© : vigilance accrue (v√©rifier limites d‚Äôemploi / coh√©rence avec besoin r√©el).");
  }
  if (S.productType === "catalogue_assoc"){
    warnings.push("Association/int√©gration catalogue : vigilance accrue (compatibilit√©s + coh√©rence globale de solution).");
  }

  const management = triggers.length
    ? `‚úÖ Sollicitation recommand√©e/obligatoire : ${triggers.join(" ¬∑ ")}`
    : "‚ùå Pas de sollicitation management requise";

  return {
    level, sla, priority, management, action,
    warnings,
    note:"Objectif : aller vite quand c‚Äôest ma√Ætris√©, s√©curiser quand la d√©cision engage l‚Äôentreprise."
  };
}

function showResult(){
  const d = computeDecision();
  const box = el("result");
  box.style.display = "block";

  const warnHtml = (d.warnings && d.warnings.length)
    ? `<div class="note warn"><b>Points de vigilance :</b><ul>${d.warnings.map(w=>`<li>${escapeHtml(w)}</li>`).join("")}</ul></div>`
    : "";

  box.innerHTML = `
    <h2>‚úÖ R√©sultat</h2>
    <div class="kvs">
      <div class="kv"><div class="k">Niveau</div><div class="v">${escapeHtml(d.level)} <span class="pill">${escapeHtml(d.sla)}</span></div></div>
      <div class="kv"><div class="k">Priorit√©</div><div class="v">${escapeHtml(d.priority)}</div></div>
      <div class="kv"><div class="k">Sollicitation management</div><div class="v">${escapeHtml(d.management)}</div></div>
      <div class="kv"><div class="k">Action recommand√©e</div><div class="v">${escapeHtml(d.action)}</div></div>
    </div>
    ${warnHtml}
    <div class="note ok"><b>Note :</b> ${escapeHtml(d.note)}</div>
    <div class="divider"></div>
    <div class="row">
      <button class="primary" onclick="window.__restart()">‚Ü©Ô∏è Recommencer</button>
    </div>
  `;
}

function renderNode(node){
  switch(node){

    case "rating": {
      setStep("√âtape 0 ‚Äî Notation client ERP", "S√©lectionne la notation (A‚ÜíF). N4 est d√©clench√© imm√©diatement sur F.");
      addBtn("A (fiable & actif)", ()=>{ S.rating="A"; renderNode("q"); }, true);
      addBtn("B (fiable √† potentiel)", ()=>{ S.rating="B"; renderNode("q"); });
      addBtn("C (d√©couverte)", ()=>{ S.rating="C"; renderNode("q"); });
      addBtn("D (0% transform√© + >5 devis)", ()=>{ S.rating="D"; renderNode("q"); });
      addBtn("E (retard > 20j)", ()=>{ S.rating="E"; renderNode("q"); });
      addBtn("F (retard > 45j)", ()=>{ S.rating="F"; showResult(); });
      break;
    }

    case "q": {
      setStep("√âtape 1 ‚Äî Qualit√© de la demande (Q1‚ÄìQ3)", "‚ö†Ô∏è N4 est d√©clench√© si Q3 est associ√© √† un client D ou E (pas de r√©ponse).");
      addBtn("Q1 ‚Äî Forte (clair + achat + urgence)", ()=>{ S.q="Q1"; renderNode("urgent"); }, true);
      addBtn("Q2 ‚Äî Moyenne (incomplet)", ()=>{ S.q="Q2"; renderNode("urgent"); });
      addBtn("Q3 ‚Äî Faible / inadapt√©e", ()=>{
        S.q="Q3";
        if (isLevel4Triggered()) showResult();
        else renderNode("urgent");
      });
      break;
    }

    case "urgent": {
      setStep("√âtape 2 ‚Äî Achat rapide / client press√© ?", "Le client a-t-il une contrainte de d√©lai forte (r√©activit√© attendue) ?");
      addBtn("‚úÖ Oui, client press√©", ()=>{ S.urgent=true; renderNode("stock"); }, true);
      addBtn("‚ùå Non, d√©lai standard", ()=>{ S.urgent=false; renderNode("stock"); });
      break;
    }

    case "stock": {
      setStep("√âtape 3 ‚Äî Produit disponible imm√©diatement (stock) ?", "Si stock = oui, alors produit catalogue (ma√Ætris√©) + fournisseur ma√Ætris√© (cha√Æne logistique et prix connus).");
      addBtn("‚úÖ Oui, produit en stock", ()=>{
        S.stock = true;
        S.productType = "catalogue_std";
        S.supplierMastered = true;
        S.supplierNew = false;
        renderNode("techValidation");
      }, true);

      addBtn("‚ùå Non, produit √† commander", ()=>{
        S.stock = false;
        renderNode("productType");
      });
      break;
    }

    case "productType": {
      setStep("√âtape 4 ‚Äî Type de produit", "S√©lectionne la nature de l‚Äôoffre : plus on s‚Äô√©loigne du catalogue standard, plus le risque et le d√©lai augmentent.");
      addBtn("üìó Produit catalogue (ma√Ætris√©)", ()=>{
        S.productType = "catalogue_std";
        renderNode("supplier");
      }, true);

      addBtn("üìò Produit catalogue adapt√© (vigilance +)", ()=>{
        S.productType = "catalogue_adapte";
        renderNode("supplier");
      });

      addBtn("üß© Association / int√©gration produits catalogue (vigilance ++)", ()=>{
        S.productType = "catalogue_assoc";
        renderNode("supplier");
      });

      addBtn("üìô Hors catalogue (nouveau risque)", ()=>{
        S.productType = "hors_catalogue";
        renderNode("supplier");
      });
      break;
    }

    case "supplier": {
      setStep("√âtape 5 ‚Äî Fournisseur ma√Ætris√© ?", "Un fournisseur ma√Ætris√© rend la r√©ponse plus fiable (d√©lai/prix/logistique). Coche ‚ÄúNouveau fournisseur‚Äù si premier dossier/aucun historique.");

      addInputHTML(`
        <div class="field">
          <div class="chk">
            <input id="supplierNew" type="checkbox" />
            <div>
              <b>Nouveau fournisseur</b>
              <div class="small">Fournisseur non r√©f√©renc√© / premi√®re commande / pas d‚Äôhistorique. (Impact identique √† l‚Äôancienne r√®gle de l‚Äô√©tape 7.)</div>
            </div>
          </div>
          <div class="small">Si coch√©, on consid√®re le fournisseur comme ‚Äúnon ma√Ætris√©‚Äù par prudence.</div>
        </div>
      `);

      el("supplierNew").onchange = (e)=>{ S.supplierNew = !!e.target.checked; };

      addBtn("‚úÖ Oui, fournisseur ma√Ætris√©", ()=>{
        // Si "nouveau fournisseur" coch√©, on force une lecture prudente
        S.supplierMastered = (S.supplierNew === true) ? false : true;
        renderNode("techValidation");
      }, true);

      addBtn("‚ùå Non, fournisseur non ma√Ætris√©", ()=>{
        S.supplierMastered = false;
        renderNode("techValidation");
      });

      break;
    }

    case "techValidation": {
      setStep("√âtape 6 ‚Äî Validation technique & r√©glementaire acquise ?", "Peux-tu reformuler le besoin (usage/charge/environnement) et valider l‚Äôad√©quation technique ET r√©glementaire ?");
      addInputHTML(`
        <div class="field">
          <div class="chk"><input id="doubtReg" type="checkbox" />
            <div><b>Doute r√©glementaire</b><div class="small">Coche si l‚Äôusage / exigence applicable n‚Äôest pas clair (levage vs traction, documents requis, limites d‚Äôemploi‚Ä¶).</div></div>
          </div>
        </div>
      `);
      el("doubtReg").onchange = (e)=>{ S.doubtReg = !!e.target.checked; };

      addBtn("‚úÖ Oui, validation acquise", ()=>{ S.validationOK=true; renderNode("financial"); }, true);
      addBtn("‚ùå Non / incertain", ()=>{ S.validationOK=false; renderNode("financial"); });
      break;
    }

    case "financial": {
      setStep("√âtape 7 ‚Äî Crit√®res financiers", "Renseigne uniquement les √©l√©ments financiers : montant dossier et marge. (La partie fournisseur et structuration est trait√©e plus t√¥t.)");

      addInputHTML(`
        <div class="grid">
          <div class="field">
            <label>Montant du dossier (‚Ç¨)</label>
            <input id="amount" type="number" min="0" step="1" placeholder="Ex : 4200" />
            <div class="small">Seuil utilis√© : nouveau fournisseur (> 1 000 ‚Ç¨) (si case coch√©e √† l‚Äô√©tape 5).</div>
          </div>
          <div class="field">
            <label>Marge (%)</label>
            <input id="margin" type="number" min="0" max="100" step="0.1" placeholder="Ex : 24.5" />
            <div class="small">R√®gle : marge &lt; 22% et montant ‚â• 5 000‚Ç¨ ‚Üí arbitrage.</div>
          </div>
        </div>
      `);

      el("amount").oninput = (e)=>{ S.amount = e.target.value === "" ? null : Number(e.target.value); };
      el("margin").oninput = (e)=>{ S.margin = e.target.value === "" ? null : Number(e.target.value); };

      addBtn("‚úÖ Calculer le r√©sultat", ()=>showResult(), true);
      addBtn("‚Ü©Ô∏è Revenir au d√©but", ()=>resetAll());
      break;
    }
  }
}

window.__restart = resetAll;
renderNode("rating");
</script>
</body>
</html>
