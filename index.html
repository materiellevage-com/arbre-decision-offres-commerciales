<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Arbre de d√©cision ‚Äî Offres commerciales (MATERIEL-LEVAGE)</title>
  <style>
    :root { --b:#e5e7eb; --t:#111827; --m:#6b7280; --bg:#ffffff; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; color: var(--t); background: var(--bg); }
    .wrap { max-width: 860px; margin: 0 auto; }
    .card { border: 1px solid var(--b); border-radius: 14px; padding: 14px; }
    .top { display:flex; align-items:flex-start; justify-content:space-between; gap: 10px; flex-wrap: wrap; }
    .badge { display:inline-block; padding: 4px 10px; border-radius: 999px; border:1px solid var(--b); font-size: 12px; }
    h1 { font-size: 18px; margin: 10px 0 6px; }
    .sub { color: var(--m); font-size: 13px; }
    .divider { height: 1px; background: var(--b); margin: 12px 0; }
    .stepTitle { font-weight: 800; margin: 0 0 4px; }
    .stepDesc { color: var(--m); font-size: 13px; margin: 0 0 10px; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #d1d5db; background: white; cursor: pointer; }
    button:hover { border-color: #9ca3af; }
    button.primary { border-color:#111827; font-weight:700; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr; } }
    .field { border:1px solid var(--b); border-radius: 12px; padding: 10px; }
    label { font-size: 12px; color: var(--m); display:block; margin-bottom: 6px; }
    input[type="number"]{ width: 100%; padding: 10px; border-radius: 10px; border:1px solid #d1d5db; }
    input[type="checkbox"]{ transform: translateY(1px); }
    .chk { display:flex; align-items:flex-start; gap:8px; font-size: 13px; color: var(--t); }
    .result { display:none; border:1px solid var(--b); border-radius: 14px; padding: 12px; background:#fafafa; }
    .result h2 { margin: 0 0 8px; font-size: 16px; }
    .kvs { display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
    .kv { border:1px solid var(--b); border-radius: 12px; padding: 10px; background:white; }
    .kv .k { color: var(--m); font-size: 12px; margin-bottom: 4px; }
    .kv .v { font-weight: 800; }
    .note { margin-top: 10px; color: #374151; font-size: 13px; }
    .small { font-size: 12px; color: var(--m); margin-top: 6px; }
    .pill { display:inline-block; padding: 2px 8px; border:1px solid var(--b); border-radius: 999px; font-size: 12px; margin-left: 6px; color: #374151;}
    .warn { color: #7c2d12; }
    .ok { color: #065f46; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <span class="badge">MATERIEL-LEVAGE</span>
          <h1>üå≥ Arbre de d√©cision ‚Äî Priorisation des offres</h1>
          <div class="sub">Objectif : r√©pondre vite et juste, en sollicitant le support manag√©rial au plus juste.</div>
          <div class="small">R√®gle terrain : si tu h√©sites entre deux niveaux, choisis le plus haut.</div>
        </div>
        <div class="badge">SLA : N0 &lt;24h ¬∑ N1 &lt;48h ¬∑ N2 48‚Äì72h ¬∑ N3 4‚Äì5j</div>
      </div>

      <div class="divider"></div>

      <div id="step">
        <div class="stepTitle" id="stepTitle"></div>
        <div class="stepDesc" id="stepDesc"></div>

        <div id="inputs"></div>
        <div class="row" id="choices"></div>
      </div>

      <div class="result" id="result"></div>
    </div>
  </div>

<script>
/**
 * Mod√®le : √âtapes guid√©es + calcul de d√©cision finale
 * - √âtape 0 : Notation client A..F (ERP) -> garde-fous E/F, filtre D
 * - √âtape 1 : Qualit√© demande Q1..Q3
 * - √âtape 2 : Achat rapide (urgence) ? + stock / fournisseur ma√Ætris√©
 * - √âtape 3 : Type produit (catalogue / hors catalogue) + fournisseur ma√Ætris√© ?
 * - √âtape 4 : Validation technique acquise ? (besoin + technique + r√©glementaire)
 * - √âtape 5 : Crit√®res management (nouveau fournisseur, marge<22% + montant, etc.)
 */

const SLA = {
  N0: "< 24 h",
  N1: "< 48 h",
  N2: "48‚Äì72 h",
  N3: "4‚Äì5 jours ouvr√©s"
};

// √âtat
const S = {
  rating: null,        // A..F
  q: null,             // Q1..Q3
  urgent: null,        // true/false
  stock: null,         // true/false
  supplierMastered: null, // true/false (si pas stock / hors catalogue)
  productType: null,   // "catalogue" | "hors_catalogue"
  supplierNew: false,  // bool
  amount: null,        // number ‚Ç¨
  margin: null,        // number %
  marginOverride: false, // bool (si la marge est un sujet)
  validationOK: null,  // true/false (besoin+technique+r√©glementaire)
  doubtReg: false,     // bool
};

function el(id){ return document.getElementById(id); }
function resetAll(){
  Object.keys(S).forEach(k => {
    if (typeof S[k] === "boolean") S[k] = false;
    else S[k] = null;
  });
  S.supplierNew = false;
  S.marginOverride = false;
  S.doubtReg = false;
  renderNode("rating");
}

function setStep(title, desc){
  el("stepTitle").textContent = title;
  el("stepDesc").textContent = desc;
  el("choices").innerHTML = "";
  el("inputs").innerHTML = "";
  el("result").style.display = "none";
}

function addBtn(label, onClick, primary=false){
  const b = document.createElement("button");
  b.textContent = label;
  if (primary) b.classList.add("primary");
  b.onclick = onClick;
  el("choices").appendChild(b);
}

function addInputHTML(html){
  const d = document.createElement("div");
  d.innerHTML = html;
  el("inputs").appendChild(d);
}

// D√©cision finale : niveau + priorit√© + management + actions
function computeDecision(){
  // 1) Garde-fous paiement
  if (S.rating === "F"){
    return {
      level: "N3",
      priority: "‚ö´ Priorit√© tr√®s faible",
      management: "‚úÖ Obligatoire (arbitrage avant devis/commande)",
      action: "Arbitrage manag√©rial obligatoire. Pas de poursuite commerciale sans d√©cision.",
      warnings: ["Client F : retard >45 jours ‚Üí arbitrage obligatoire avant tout engagement."]
    };
  }

  const warnings = [];
  const managementTriggers = [];

  if (S.rating === "E"){
    managementTriggers.push("Client E : retard >20 jours ‚Üí s√©curisation paiement / conditions renforc√©es");
    warnings.push("Client E : s√©curiser paiement avant engagement logistique.");
  }

  // 2) Filtre D (consommateur de devis)
  const isFilterD = (S.rating === "D");
  if (isFilterD) warnings.push("Client D : qualification obligatoire avant devis d√©taill√© (√©viter consommation de devis).");

  // 3) Qualit√© demande et r√©ponse produit -> priorit√© "de base"
  // Base priority from matrix Q x R
  const R = (S.stock === true) ? "R1" : (S.supplierMastered === true && S.productType === "catalogue") ? "R2"
            : (S.supplierMastered === true && S.productType === "hors_catalogue") ? "R3" : "R3";

  // Priorit√© indicative
  let priority = "üü° Priorit√© normale";
  if (S.q === "Q1" && R === "R1") priority = "üî¥ Priorit√© max";
  else if (S.q === "Q1" && R === "R2") priority = "üü† Priorit√© haute";
  else if (S.q === "Q1" && R === "R3") priority = "üü° Priorit√© ajust√©e";
  else if (S.q === "Q2" && R === "R1") priority = "üü† Priorit√© haute";
  else if (S.q === "Q2" && R === "R2") priority = "üü° Priorit√© normale";
  else if (S.q === "Q2" && R === "R3") priority = "üîµ Priorit√© basse";
  else if (S.q === "Q3" && R === "R1") priority = "üü° Priorit√© normale";
  else if (S.q === "Q3" && R === "R2") priority = "üîµ Priorit√© basse";
  else if (S.q === "Q3" && R === "R3") priority = "‚ö´ Priorit√© tr√®s faible";

  // 4) Niveau (N0..N3)
  // N0 est r√©serv√© panier web + compl√©ment simple : pas g√©r√© ici (si tu veux l‚Äôajouter, on peut)
  // Ici : N1 (catalogue/stock standard), N2 (ajustements/hors catalogue), N3 (structurant / risque √©lev√© / F)
  let level = "N1";
  if (S.productType === "hors_catalogue" || (S.productType === "catalogue" && S.stock === false && S.supplierMastered === false)) level = "N2";
  if (S.q === "Q3" && R === "R3") level = "N3"; // tr√®s faible + incertain -> pilotage/filtrage

  // 5) Validation technique
  if (S.validationOK === false || S.doubtReg === true){
    managementTriggers.push("Validation technique/r√©glementaire non acquise (doute ou validation impossible)");
    warnings.push("Doute technique/r√©glementaire : solliciter support pour s√©curiser l‚Äôad√©quation au besoin.");
  }

  // 6) R√®gles sp√©cifiques management (selon tes crit√®res)
  // - Nouveau fournisseur : management si dossier > 1000 ‚Ç¨
  if (S.supplierNew === true){
    if (typeof S.amount === "number" && S.amount > 1000){
      managementTriggers.push("Nouveau fournisseur + dossier > 1 000 ‚Ç¨");
    } else {
      warnings.push("Nouveau fournisseur : vigilance (seuil management > 1 000 ‚Ç¨).");
    }
  }

  // - Marge < 22% si dossier ‚â• 5 000 ‚Ç¨
  if (typeof S.margin === "number" && typeof S.amount === "number"){
    if (S.margin < 22 && S.amount >= 5000){
      managementTriggers.push("Marge < 22% sur dossier ‚â• 5 000 ‚Ç¨ (arbitrage)");
    }
  }

  // - Hors catalogue + fournisseur non ma√Ætris√© : management
  if (S.productType === "hors_catalogue" && S.supplierMastered === false){
    managementTriggers.push("Produit hors catalogue + fournisseur non ma√Ætris√©");
    warnings.push("Hors catalogue + fournisseur non ma√Ætris√© : s√©curiser d√©lais/prix/logistique avant promesse.");
  }

  // - Association catalogue / hors catalogue : si validation technique OK => autonomie
  // (d√©j√† g√©r√© via validationOK; on ne force pas management)

  // 7) Client D : on privil√©gie qualification avant devis d√©taill√©
  let action = "Produire une offre coh√©rente (besoin ‚Üí solution), avec d√©lai r√©aliste.";
  if (isFilterD){
    action = "Qualifier avant devis d√©taill√© : exiger infos + √©ch√©ance + d√©cisionnaire. Proposer pr√©-cadrage / fiche de sp√©cification.";
  }

  // 8) Management requis ?
  const management = (managementTriggers.length > 0) ? "‚ö†Ô∏è Oui (au plus juste)" : "‚ùå Non (autonomie)";
  if (managementTriggers.length > 0) level = (level === "N1") ? "N2" : level; // bascule vers N2 si besoin support

  // 9) SLA (affichage)
  let sla = SLA[level] || "‚Äî";
  // Ajustement SLA hors catalogue / non ma√Ætris√©
  if (S.productType === "hors_catalogue"){
    sla = (S.supplierMastered === true) ? "3 jours (cible)" : "3‚Äì5 jours (cible)";
  } else if (S.productType === "catalogue"){
    sla = (S.stock === true) ? "< 24 h (cible)" : "< 48 h (cible)";
  }

  // 10) Notes orient√©es opportunit√©
  const opportunityNote = "Objectif : aller vite quand c‚Äôest ma√Ætris√©, s√©curiser quand la d√©cision engage l‚Äôentreprise.";

  return {
    level,
    priority,
    management: managementTriggers.length ? `‚úÖ Sollicitation recommand√©e/obligatoire : ${managementTriggers.join(" ¬∑ ")}` : "‚ùå Pas de sollicitation management requise",
    sla,
    action,
    warnings,
    opportunityNote
  };
}

function showResult(){
  const d = computeDecision();
  const box = el("result");
  box.style.display = "block";

  const warnHtml = (d.warnings && d.warnings.length)
    ? `<div class="note warn"><b>Points de vigilance :</b><ul>${d.warnings.map(w=>`<li>${escapeHtml(w)}</li>`).join("")}</ul></div>`
    : "";

  box.innerHTML = `
    <h2>‚úÖ R√©sultat</h2>

    <div class="kvs">
      <div class="kv"><div class="k">Niveau</div><div class="v">${escapeHtml(d.level)} <span class="pill">${escapeHtml(d.sla || "")}</span></div></div>
      <div class="kv"><div class="k">Priorit√©</div><div class="v">${escapeHtml(d.priority)}</div></div>
      <div class="kv"><div class="k">Sollicitation management</div><div class="v">${escapeHtml(d.management)}</div></div>
      <div class="kv"><div class="k">Action recommand√©e</div><div class="v">${escapeHtml(d.action)}</div></div>
    </div>

    ${warnHtml}

    <div class="note ok"><b>Note :</b> ${escapeHtml(d.opportunityNote || "")}</div>

    <div class="divider"></div>
    <div class="row">
      <button class="primary" onclick="window.__restart()">‚Ü©Ô∏è Recommencer</button>
    </div>
  `;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// N≈ìuds (√©tapes)
function renderNode(node){
  switch(node){

    case "rating": {
      setStep("√âtape 0 ‚Äî Notation client ERP", "S√©lectionne la notation (A‚ÜíF). Elle oriente l‚Äôeffort (qualification, s√©curisation paiement, arbitrage).");
      addBtn("A (fiable & actif)", ()=>{ S.rating="A"; renderNode("q"); }, true);
      addBtn("B (fiable √† potentiel)", ()=>{ S.rating="B"; renderNode("q"); });
      addBtn("C (d√©couverte)", ()=>{ S.rating="C"; renderNode("q"); });
      addBtn("D (0% transform√© + >5 devis)", ()=>{ S.rating="D"; renderNode("q"); });
      addBtn("E (retard > 20j)", ()=>{ S.rating="E"; renderNode("q"); });
      addBtn("F (retard > 45j)", ()=>{ S.rating="F"; showResult(); });
      break;
    }

    case "q": {
      setStep("√âtape 1 ‚Äî Qualit√© de la demande (Q1‚ÄìQ3)", "Choisis le niveau de clart√©/urgence de la demande. Une demande de prix pr√©cise et un besoin clair augmentent la priorit√©.");
      addBtn("Q1 ‚Äî Forte (clair + achat + urgence)", ()=>{ S.q="Q1"; renderNode("urgent"); }, true);
      addBtn("Q2 ‚Äî Moyenne (incomplet)", ()=>{ S.q="Q2"; renderNode("urgent"); });
      addBtn("Q3 ‚Äî Faible / inadapt√©e", ()=>{ S.q="Q3"; renderNode("urgent"); });
      break;
    }

    case "urgent": {
      setStep("√âtape 2 ‚Äî Achat rapide / client press√© ?", "Le client a-t-il une contrainte de d√©lai forte (r√©activit√© attendue) ?");
      addBtn("‚úÖ Oui, client press√©", ()=>{ S.urgent=true; renderNode("stock"); }, true);
      addBtn("‚ùå Non, d√©lai standard", ()=>{ S.urgent=false; renderNode("stock"); });
      break;
    }

    case "stock": {
      setStep("√âtape 3 ‚Äî Produit disponible imm√©diatement (stock) ?", "Crit√®re de r√©activit√© : si le client est press√© et que tu ma√Ætrises stock + prix + logistique, la priorit√© monte.");
      addBtn("‚úÖ Oui, produit en stock", ()=>{ S.stock=true; renderNode("productType"); }, true);
      addBtn("‚ùå Non, produit √† commander", ()=>{ S.stock=false; renderNode("productType"); });
      break;
    }

    case "productType": {
      setStep("√âtape 4 ‚Äî Type de produit", "Catalogue = ma√Ætrise √©lev√©e. Hors catalogue = vigilance renforc√©e (encore plus si fournisseur non ma√Ætris√©).");
      addBtn("üìó Produit catalogue", ()=>{ S.productType="catalogue"; renderNode("supplier"); }, true);
      addBtn("üìô Hors catalogue", ()=>{ S.productType="hors_catalogue"; renderNode("supplier"); });
      break;
    }

    case "supplier": {
      setStep("√âtape 5 ‚Äî Fournisseur ma√Ætris√© ?", "Un fournisseur ma√Ætris√© permet une r√©ponse plus fiable (d√©lai/prix/logistique). Non ma√Ætris√© = s√©curiser avant de promettre.");
      addBtn("‚úÖ Oui, fournisseur ma√Ætris√©", ()=>{ S.supplierMastered=true; renderNode("techValidation"); }, true);
      addBtn("‚ùå Non, fournisseur non ma√Ætris√©", ()=>{ S.supplierMastered=false; renderNode("techValidation"); });
      break;
    }

    case "techValidation": {
      setStep("√âtape 6 ‚Äî Validation technique & r√©glementaire acquise ?", "Peux-tu reformuler le besoin (usage/charge/environnement), et valider l‚Äôad√©quation technique ET r√©glementaire de la solution ?");
      addInputHTML(`
        <div class="field">
          <div class="chk"><input id="doubtReg" type="checkbox" />
            <div><b>Doute r√©glementaire</b><div class="small">Coche si l‚Äôusage/texte applicable n‚Äôest pas clair (levage vs traction, documents requis, limites d‚Äôemploi, etc.).</div></div>
          </div>
        </div>
      `);
      el("doubtReg").onchange = (e)=>{ S.doubtReg = !!e.target.checked; };

      addBtn("‚úÖ Oui, validation acquise", ()=>{ S.validationOK=true; renderNode("managementRules"); }, true);
      addBtn("‚ùå Non / incertain", ()=>{ S.validationOK=false; renderNode("managementRules"); });
      break;
    }

    case "managementRules": {
      setStep("√âtape 7 ‚Äî Crit√®res de sollicitation management", "Renseigne les crit√®res engageants (fournisseur, marge, montant). Le but est de solliciter au plus juste.");
      addInputHTML(`
        <div class="grid">
          <div class="field">
            <label>Montant du dossier (‚Ç¨)</label>
            <input id="amount" type="number" min="0" step="1" placeholder="Ex : 4200" />
            <div class="small">Utilis√© pour les seuils : nouveau fournisseur (>1 000‚Ç¨) et marge <22% (‚â•5 000‚Ç¨).</div>
          </div>
          <div class="field">
            <label>Marge (%)</label>
            <input id="margin" type="number" min="0" max="100" step="0.1" placeholder="Ex : 24.5" />
            <div class="small">Si < 22% et montant ‚â• 5 000‚Ç¨ ‚Üí arbitrage.</div>
          </div>
        </div>

        <div class="field" style="margin-top:10px;">
          <div class="chk"><input id="supplierNew" type="checkbox" />
            <div><b>Nouveau fournisseur</b><div class="small">Fournisseur non r√©f√©renc√© / premi√®re commande / pas d‚Äôhistorique.</div></div>
          </div>
          <div style="height:8px;"></div>
          <div class="chk"><input id="marginOverride" type="checkbox" />
            <div><b>N√©gociation de marge en-dessous du cadre</b><div class="small">Coche si le sujet ‚Äúmarge‚Äù est un point de d√©cision (ex : effort commercial demand√©).</div></div>
          </div>
        </div>

        <div class="field" style="margin-top:10px;">
          <div class="chk"><input id="structuring" type="checkbox" />
            <div><b>Offre structurante (impact catalogue / r√®gles)</b><div class="small">Coche si l‚Äôopportunit√© modifie l‚Äôoffre MATERIEL-LEVAGE (nouvelle r√®gle, nouvelle famille, standardisation, etc.).</div></div>
          </div>
        </div>
      `);

      el("amount").oninput = (e)=>{ S.amount = e.target.value === "" ? null : Number(e.target.value); };
      el("margin").oninput = (e)=>{ S.margin = e.target.value === "" ? null : Number(e.target.value); };
      el("supplierNew").onchange = (e)=>{ S.supplierNew = !!e.target.checked; };
      el("marginOverride").onchange = (e)=>{ S.marginOverride = !!e.target.checked; };
      el("structuring").onchange = (e)=>{
        // si structurant -> on force N3 via validation computeDecision (on l‚Äôutilise en ‚Äúwarning/trigger‚Äù)
        // pour rester simple, on encode en ‚ÄúvalidationOK=false‚Äù si coch√© ? Non.
        // On ajoute plut√¥t un d√©clencheur via supplierNew? -> ici on passe par un flag local.
        // => On stocke dans S via une propri√©t√© dynamic :
        S.structuring = !!e.target.checked;
      };

      addBtn("‚úÖ Calculer le r√©sultat", ()=>{
        // Si structurant, on force une d√©cision N3 + management
        if (S.structuring === true){
          // On surclasse le r√©sultat via un hack simple : mettre validationOK=false ET produit hors catalogue+non ma√Ætris√© ?
          // Mieux : on injecte un trigger dans warnings/management via un champ d√©di√©.
          // On va g√©rer dans computeDecision via pr√©sence S.structuring.
        }
        showResult();
      }, true);

      addBtn("‚Ü©Ô∏è Revenir au d√©but", ()=>resetAll());
      break;
    }
  }
}

// Patch computeDecision pour prendre en compte "structuring"
const _computeDecision = computeDecision;
computeDecision = function(){
  const d = _computeDecision();
  // Si offre structurante coch√©e : N3 + management obligatoire
  if (S.structuring === true){
    const extraWarn = (d.warnings || []);
    extraWarn.push("Offre structurante : impact catalogue/r√®gles ‚Üí pilotage manag√©rial.");
    return {
      ...d,
      level: "N3",
      priority: d.priority.startsWith("üî¥") ? d.priority : "üîµ Priorit√© structurante",
      sla: SLA["N3"],
      management: "‚úÖ Obligatoire (offre structurante : pilotage + capitalisation)",
      warnings: extraWarn,
      action: "Pilotage manag√©rial : cadrage technique/r√®glementaire + d√©cision d‚Äôint√©gration (r√®gles, catalogue, standard)."
    };
  }
  return d;
};

window.__restart = resetAll;

// Init
renderNode("rating");
</script>
</body>
</html>
