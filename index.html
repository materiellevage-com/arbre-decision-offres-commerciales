<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Arbre de d√©cision ‚Äî Offres commerciales (MATERIEL-LEVAGE)</title>
  <style>
    :root { --b:#e5e7eb; --t:#111827; --m:#6b7280; --bg:#ffffff; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; color: var(--t); background: var(--bg); }
    .wrap { max-width: 860px; margin: 0 auto; }
    .card { border: 1px solid var(--b); border-radius: 14px; padding: 14px; }
    .top { display:flex; align-items:flex-start; justify-content:space-between; gap: 10px; flex-wrap: wrap; }
    .badge { display:inline-block; padding: 4px 10px; border-radius: 999px; border:1px solid var(--b); font-size: 12px; }
    h1 { font-size: 18px; margin: 10px 0 6px; }
    .sub { color: var(--m); font-size: 13px; }
    .divider { height: 1px; background: var(--b); margin: 12px 0; }
    .stepTitle { font-weight: 800; margin: 0 0 4px; }
    .stepDesc { color: var(--m); font-size: 13px; margin: 0 0 10px; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #d1d5db; background: white; cursor: pointer; }
    button:hover { border-color: #9ca3af; }
    button.primary { border-color:#111827; font-weight:700; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr; } }
    .field { border:1px solid var(--b); border-radius: 12px; padding: 10px; }
    label { font-size: 12px; color: var(--m); display:block; margin-bottom: 6px; }
    input[type="number"]{ width: 100%; padding: 10px; border-radius: 10px; border:1px solid #d1d5db; }
    input[type="checkbox"]{ transform: translateY(1px); }
    .chk { display:flex; align-items:flex-start; gap:8px; font-size: 13px; color: var(--t); }
    .result { display:none; border:1px solid var(--b); border-radius: 14px; padding: 12px; background:#fafafa; }
    .result h2 { margin: 0 0 8px; font-size: 16px; }
    .kvs { display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
    .kv { border:1px solid var(--b); border-radius: 12px; padding: 10px; background:white; }
    .kv .k { color: var(--m); font-size: 12px; margin-bottom: 4px; }
    .kv .v { font-weight: 800; }
    .note { margin-top: 10px; color: #374151; font-size: 13px; }
    .small { font-size: 12px; color: var(--m); margin-top: 6px; }
    .pill { display:inline-block; padding: 2px 8px; border:1px solid var(--b); border-radius: 999px; font-size: 12px; margin-left: 6px; color: #374151;}
    .warn { color: #7c2d12; }
    .ok { color: #065f46; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <span class="badge">MATERIEL-LEVAGE</span>
          <h1>üå≥ Arbre de d√©cision ‚Äî Priorisation des offres</h1>
          <div class="sub">Objectif : r√©pondre vite et juste, en sollicitant le support manag√©rial au plus juste.</div>
          <div class="small">R√®gle terrain : si tu h√©sites entre deux niveaux, choisis le plus haut.</div>
        </div>
        <div class="badge">SLA : N0 &lt;24h ¬∑ N1 &lt;48h ¬∑ N2 48‚Äì72h ¬∑ N3 4‚Äì5j</div>
      </div>

      <div class="divider"></div>

      <div id="step">
        <div class="stepTitle" id="stepTitle"></div>
        <div class="stepDesc" id="stepDesc"></div>

        <div id="inputs"></div>
        <div class="row" id="choices"></div>
      </div>

      <div class="result" id="result"></div>
    </div>
  </div>

<script>
const SLA = { D√©lais moyens de r√©ponse:"< 24 h", N1:"< 48 h", N2:"48‚Äì72 h", N3:"4‚Äì5 jours ouvr√©s" };

const S = {
  rating: null, q: null, urgent: null,
  stock: null,
  productType: null,         // "catalogue" | "hors_catalogue"
  supplierMastered: null,    // true/false
  validationOK: null,
  doubtReg: false,
  amount: null,
  margin: null,
  supplierNew: false,
  structuring: false
};

function el(id){ return document.getElementById(id); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function resetAll(){
  S.rating=null; S.q=null; S.urgent=null;
  S.stock=null; S.productType=null; S.supplierMastered=null;
  S.validationOK=null; S.doubtReg=false;
  S.amount=null; S.margin=null;
  S.supplierNew=false; S.structuring=false;
  renderNode("rating");
}

function setStep(title, desc){
  el("stepTitle").textContent = title;
  el("stepDesc").textContent = desc;
  el("choices").innerHTML = "";
  el("inputs").innerHTML = "";
  el("result").style.display = "none";
}
function addBtn(label, onClick, primary=false){
  const b = document.createElement("button");
  b.textContent = label;
  if (primary) b.classList.add("primary");
  b.onclick = onClick;
  el("choices").appendChild(b);
}
function addInputHTML(html){
  const d = document.createElement("div");
  d.innerHTML = html;
  el("inputs").appendChild(d);
}

function computeDecision(){
  // Paiement / garde-fous
  if (S.rating === "F"){
    return {
      level:"N3", sla:SLA.N3,
      priority:"‚ö´ Priorit√© tr√®s faible",
      management:"‚úÖ Obligatoire (arbitrage avant devis/commande)",
      action:"Arbitrage manag√©rial obligatoire. Pas de poursuite commerciale sans d√©cision.",
      warnings:["Client F : retard >45 jours ‚Üí arbitrage obligatoire avant tout engagement."],
      opportunityNote:"Objectif : s√©curiser l‚Äôentreprise et pr√©server le commerce durable."
    };
  }

  const warnings = [];
  const triggers = [];

  if (S.rating === "E"){
    triggers.push("Client E : retard >20 jours (s√©curisation paiement)");
    warnings.push("Client E : s√©curiser paiement avant engagement logistique.");
  }
  const isFilterD = (S.rating === "D");
  if (isFilterD){
    warnings.push("Client D : qualification obligatoire avant devis d√©taill√© (√©viter consommation de devis).");
  }

  // R : capacit√© de r√©ponse
  // IMPORTANT : si stock=true => catalogue + fournisseur ma√Ætris√© (d√©j√† forc√© en amont)
  let R = "R3";
  if (S.stock === true) R = "R1";
  else if (S.productType === "catalogue" && S.supplierMastered === true) R = "R2";
  else R = "R3";

  // Priorit√© (matrice)
  let priority = "üü° Priorit√© normale";
  if (S.q === "Q1" && R === "R1") priority = "üî¥ Priorit√© max";
  else if (S.q === "Q1" && R === "R2") priority = "üü† Priorit√© haute";
  else if (S.q === "Q1" && R === "R3") priority = "üü° Priorit√© ajust√©e";
  else if (S.q === "Q2" && R === "R1") priority = "üü† Priorit√© haute";
  else if (S.q === "Q2" && R === "R2") priority = "üü° Priorit√© normale";
  else if (S.q === "Q2" && R === "R3") priority = "üîµ Priorit√© basse";
  else if (S.q === "Q3" && R === "R1") priority = "üü° Priorit√© normale";
  else if (S.q === "Q3" && R === "R2") priority = "üîµ Priorit√© basse";
  else if (S.q === "Q3" && R === "R3") priority = "‚ö´ Priorit√© tr√®s faible";

  // Niveau par d√©faut
  let level = "N1";
  if (S.productType === "hors_catalogue" || R === "R3") level = "N2";
  if (S.q === "Q3" && R === "R3") level = "N3";

  // Validation technique / r√©glementaire
  if (S.validationOK === false || S.doubtReg === true){
    triggers.push("Validation technique/r√©glementaire non acquise (doute ou validation impossible)");
    warnings.push("Doute technique/r√©glementaire : solliciter support pour s√©curiser l‚Äôad√©quation au besoin.");
  }

  // Nouveau fournisseur : management si >1000‚Ç¨
  if (S.supplierNew === true){
    if (typeof S.amount === "number" && S.amount > 1000){
      triggers.push("Nouveau fournisseur + dossier > 1 000 ‚Ç¨");
    } else {
      warnings.push("Nouveau fournisseur : vigilance (seuil management > 1 000 ‚Ç¨).");
    }
  }

  // Marge <22% si dossier >=5000‚Ç¨
  if (typeof S.margin === "number" && typeof S.amount === "number"){
    if (S.margin < 22 && S.amount >= 5000){
      triggers.push("Marge < 22% sur dossier ‚â• 5 000 ‚Ç¨ (arbitrage)");
    }
  }

  // Hors catalogue + fournisseur non ma√Ætris√©
  if (S.productType === "hors_catalogue" && S.supplierMastered === false){
    triggers.push("Produit hors catalogue + fournisseur non ma√Ætris√©");
    warnings.push("Hors catalogue + fournisseur non ma√Ætris√© : s√©curiser d√©lais/prix/logistique avant promesse.");
  }

  // Offre structurante
  if (S.structuring === true){
    triggers.push("Offre structurante (impact catalogue / r√®gles)");
    warnings.push("Offre structurante : pilotage manag√©rial + capitalisation.");
    level = "N3";
  }

  // SLA affichage
  let sla = SLA[level] || "‚Äî";
  if (level === "N1"){
    sla = (S.stock === true) ? "< 24 h (cible)" : "< 48 h (cible)";
  }
  if (level === "N2"){
    if (S.productType === "hors_catalogue"){
      sla = (S.supplierMastered === true) ? "3 jours (cible)" : "3‚Äì5 jours (cible)";
    } else {
      sla = "48‚Äì72 h (cible)";
    }
  }
  if (level === "N3"){
    sla = "4‚Äì5 jours ouvr√©s (cible)";
  }

  let action = "Produire une offre coh√©rente (besoin ‚Üí solution), avec d√©lai r√©aliste.";
  if (isFilterD){
    action = "Qualifier avant devis d√©taill√© : exiger infos + √©ch√©ance + d√©cisionnaire. Proposer pr√©-cadrage / fiche de sp√©cification.";
  }
  if (S.rating === "E"){
    action = "S√©curiser conditions de paiement avant engagement (confirmation / acompte / paiement avant exp√©dition selon cas).";
  }
  if (S.structuring === true){
    action = "Pilotage manag√©rial : cadrage technique/r√®glementaire + d√©cision d‚Äôint√©gration (r√®gles, catalogue, standard).";
  }

  const management = triggers.length
    ? `‚úÖ Sollicitation recommand√©e/obligatoire : ${triggers.join(" ¬∑ ")}`
    : "‚ùå Pas de sollicitation management requise";

  // Si triggers => au moins N2 (sauf d√©j√† N3)
  if (triggers.length && level === "N1") level = "N2";

  return {
    level, sla, priority, management, action, warnings,
    opportunityNote:"Objectif : aller vite quand c‚Äôest ma√Ætris√©, s√©curiser quand la d√©cision engage l‚Äôentreprise."
  };
}

function showResult(){
  const d = computeDecision();
  const box = el("result");
  box.style.display = "block";

  const warnHtml = (d.warnings && d.warnings.length)
    ? `<div class="note warn"><b>Points de vigilance :</b><ul>${d.warnings.map(w=>`<li>${escapeHtml(w)}</li>`).join("")}</ul></div>`
    : "";

  box.innerHTML = `
    <h2>‚úÖ R√©sultat</h2>
    <div class="kvs">
      <div class="kv"><div class="k">Niveau</div><div class="v">${escapeHtml(d.level)} <span class="pill">${escapeHtml(d.sla)}</span></div></div>
      <div class="kv"><div class="k">Priorit√©</div><div class="v">${escapeHtml(d.priority)}</div></div>
      <div class="kv"><div class="k">Sollicitation management</div><div class="v">${escapeHtml(d.management)}</div></div>
      <div class="kv"><div class="k">Action recommand√©e</div><div class="v">${escapeHtml(d.action)}</div></div>
    </div>
    ${warnHtml}
    <div class="note ok"><b>Note :</b> ${escapeHtml(d.opportunityNote)}</div>
    <div class="divider"></div>
    <div class="row">
      <button class="primary" onclick="window.__restart()">‚Ü©Ô∏è Recommencer</button>
    </div>
  `;
}

function renderNode(node){
  switch(node){

    case "rating": {
      setStep("√âtape 0 ‚Äî Notation client ERP", "S√©lectionne la notation (A‚ÜíF). Elle oriente l‚Äôeffort (qualification, s√©curisation paiement, arbitrage).");
      addBtn("A (fiable & actif)", ()=>{ S.rating="A"; renderNode("q"); }, true);
      addBtn("B (fiable √† potentiel)", ()=>{ S.rating="B"; renderNode("q"); });
      addBtn("C (d√©couverte)", ()=>{ S.rating="C"; renderNode("q"); });
      addBtn("D (0% transform√© + >5 devis)", ()=>{ S.rating="D"; renderNode("q"); });
      addBtn("E (retard > 20j)", ()=>{ S.rating="E"; renderNode("q"); });
      addBtn("F (retard > 45j)", ()=>{ S.rating="F"; showResult(); });
      break;
    }

    case "q": {
      setStep("√âtape 1 ‚Äî Qualit√© de la demande (Q1‚ÄìQ3)", "Choisis le niveau de clart√©/urgence de la demande. Une demande de prix pr√©cise et un besoin clair augmentent la priorit√©.");
      addBtn("Q1 ‚Äî Forte (clair + achat + urgence)", ()=>{ S.q="Q1"; renderNode("urgent"); }, true);
      addBtn("Q2 ‚Äî Moyenne (incomplet)", ()=>{ S.q="Q2"; renderNode("urgent"); });
      addBtn("Q3 ‚Äî Faible / inadapt√©e", ()=>{ S.q="Q3"; renderNode("urgent"); });
      break;
    }

    case "urgent": {
      setStep("√âtape 2 ‚Äî Achat rapide / client press√© ?", "Le client a-t-il une contrainte de d√©lai forte (r√©activit√© attendue) ?");
      addBtn("‚úÖ Oui, client press√©", ()=>{ S.urgent=true; renderNode("stock"); }, true);
      addBtn("‚ùå Non, d√©lai standard", ()=>{ S.urgent=false; renderNode("stock"); });
      break;
    }

    case "stock": {
      setStep("√âtape 3 ‚Äî Produit disponible imm√©diatement (stock) ?", "IMPORTANT : si le produit est en stock, il est consid√©r√© comme produit catalogue + fournisseur ma√Ætris√© (cha√Æne logistique et prix connus).");
      addBtn("‚úÖ Oui, produit en stock", ()=>{
        S.stock = true;
        S.productType = "catalogue";      // FORC√â
        S.supplierMastered = true;        // FORC√â
        S.supplierNew = false;            // Par d√©faut
        renderNode("techValidation");      // On saute Type produit + Fournisseur
      }, true);

      addBtn("‚ùå Non, produit √† commander", ()=>{
        S.stock = false;
        // On doit qualifier catalogue/hors catalogue + ma√Ætrise fournisseur
        renderNode("productType");
      });
      break;
    }

    case "productType": {
      setStep("√âtape 4 ‚Äî Type de produit", "Catalogue = ma√Ætrise √©lev√©e. Hors catalogue = vigilance renforc√©e (encore plus si fournisseur non ma√Ætris√©).");
      addBtn("üìó Produit catalogue", ()=>{ S.productType="catalogue"; renderNode("supplier"); }, true);
      addBtn("üìô Hors catalogue", ()=>{ S.productType="hors_catalogue"; renderNode("supplier"); });
      break;
    }

    case "supplier": {
      setStep("√âtape 5 ‚Äî Fournisseur ma√Ætris√© ?", "Un fournisseur ma√Ætris√© permet une r√©ponse plus fiable (d√©lai/prix/logistique). Non ma√Ætris√© = s√©curiser avant de promettre.");
      addBtn("‚úÖ Oui, fournisseur ma√Ætris√©", ()=>{ S.supplierMastered=true; renderNode("techValidation"); }, true);
      addBtn("‚ùå Non, fournisseur non ma√Ætris√©", ()=>{ S.supplierMastered=false; renderNode("techValidation"); });
      break;
    }

    case "techValidation": {
      setStep("√âtape 6 ‚Äî Validation technique & r√©glementaire acquise ?", "Peux-tu reformuler le besoin (usage/charge/environnement), et valider l‚Äôad√©quation technique ET r√©glementaire de la solution ?");
      addInputHTML(`
        <div class="field">
          <div class="chk"><input id="doubtReg" type="checkbox" />
            <div><b>Doute r√©glementaire</b><div class="small">Coche si l‚Äôusage / exigence applicable n‚Äôest pas clair (levage vs traction, documents requis, limites d‚Äôemploi‚Ä¶).</div></div>
          </div>
        </div>
      `);
      el("doubtReg").onchange = (e)=>{ S.doubtReg = !!e.target.checked; };

      addBtn("‚úÖ Oui, validation acquise", ()=>{ S.validationOK=true; renderNode("managementRules"); }, true);
      addBtn("‚ùå Non / incertain", ()=>{ S.validationOK=false; renderNode("managementRules"); });
      break;
    }

    case "managementRules": {
      setStep("√âtape 7 ‚Äî Crit√®res de sollicitation management", "Renseigne les crit√®res engageants (fournisseur, marge, montant). Le but est de solliciter au plus juste.");
      addInputHTML(`
        <div class="grid">
          <div class="field">
            <label>Montant du dossier (‚Ç¨)</label>
            <input id="amount" type="number" min="0" step="1" placeholder="Ex : 4200" />
            <div class="small">Seuils : nouveau fournisseur (>1 000‚Ç¨) ¬∑ marge <22% (‚â•5 000‚Ç¨).</div>
          </div>
          <div class="field">
            <label>Marge (%)</label>
            <input id="margin" type="number" min="0" max="100" step="0.1" placeholder="Ex : 24.5" />
            <div class="small">Si < 22% et montant ‚â• 5 000‚Ç¨ ‚Üí arbitrage.</div>
          </div>
        </div>

        <div class="field" style="margin-top:10px;">
          <div class="chk"><input id="supplierNew" type="checkbox" />
            <div><b>Nouveau fournisseur</b><div class="small">Fournisseur non r√©f√©renc√© / premi√®re commande / pas d‚Äôhistorique.</div></div>
          </div>
        </div>

        <div class="field" style="margin-top:10px;">
          <div class="chk"><input id="structuring" type="checkbox" />
            <div><b>Offre structurante (impact catalogue / r√®gles)</b><div class="small">Nouvelle famille, nouvelle r√®gle, standardisation, etc.</div></div>
          </div>
        </div>
      `);

      el("amount").oninput = (e)=>{ S.amount = e.target.value === "" ? null : Number(e.target.value); };
      el("margin").oninput = (e)=>{ S.margin = e.target.value === "" ? null : Number(e.target.value); };
      el("supplierNew").onchange = (e)=>{ S.supplierNew = !!e.target.checked; };
      el("structuring").onchange = (e)=>{ S.structuring = !!e.target.checked; };

      addBtn("‚úÖ Calculer le r√©sultat", ()=>showResult(), true);
      addBtn("‚Ü©Ô∏è Revenir au d√©but", ()=>resetAll());
      break;
    }
  }
}

window.__restart = resetAll;
renderNode("rating");
</script>
</body>
</html>
