<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>D√©mo ‚Äî Arbre de d√©cision Levage + Filtres (20 produits)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#101a33; --panel2:#0f1730; --border:#223055;
      --txt:#e7ecff; --muted:#b8c3ff; --muted2:#98a6e6;
      --ok:#39d98a; --warn:#ffcc66; --bad:#ff6b6b; --info:#6aa8ff;
      --chip:#1b2a55; --chip2:#223a7a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); background: radial-gradient(1200px 700px at 20% 0%, #182a63 0%, var(--bg) 60%);
      color:var(--txt);
    }
    header{
      padding:22px 18px; border-bottom:1px solid rgba(255,255,255,.08);
      position:sticky; top:0; background:rgba(11,18,32,.75); backdrop-filter: blur(10px); z-index:50;
    }
    header h1{margin:0; font-size:18px; letter-spacing:.2px}
    header .sub{color:var(--muted2); font-size:13px; margin-top:4px}
    main{max-width:1180px; margin:0 auto; padding:18px}
    .grid{
      display:grid; grid-template-columns: 420px 1fr; gap:14px;
    }
    @media (max-width: 1020px){
      .grid{grid-template-columns: 1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd .ttl{font-weight:700; font-size:14px}
    .card .hd .pill{
      font-size:12px; color:var(--muted);
      background: rgba(106,168,255,.12);
      border:1px solid rgba(106,168,255,.25);
      padding:5px 9px; border-radius:999px;
    }
    .card .bd{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      background: linear-gradient(180deg, rgba(106,168,255,.22), rgba(106,168,255,.08));
      border:1px solid rgba(106,168,255,.35);
      color:var(--txt); padding:10px 12px; border-radius:12px;
      cursor:pointer; font-weight:600; font-size:13px;
      transition: transform .06s ease, opacity .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
    }
    .btn.danger{
      background: rgba(255,107,107,.10);
      border-color: rgba(255,107,107,.35);
      color: var(--txt);
    }
    .btn.ok{
      background: rgba(57,217,138,.12);
      border-color: rgba(57,217,138,.35);
    }
    .btn.tiny{padding:7px 9px; font-size:12px; border-radius:10px}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      margin: 0 6px 6px 0;
    }
    .tag b{color:var(--txt); font-weight:700}
    .tag.ok{border-color: rgba(57,217,138,.35); background: rgba(57,217,138,.10)}
    .tag.warn{border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.10)}
    .tag.bad{border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.10)}
    .tag.info{border-color: rgba(106,168,255,.35); background: rgba(106,168,255,.10)}
    .field{margin:10px 0}
    label{display:block; font-size:12px; color:var(--muted2); margin-bottom:6px}
    input[type="text"], input[type="number"], select, textarea{
      width:100%; background: rgba(0,0,0,.18); color:var(--txt);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 12px; padding:10px 10px; outline:none;
      font-size:13px;
    }
    textarea{min-height: 240px; font-family: var(--mono); font-size:12px; line-height:1.35}
    input[type="range"]{width:100%}
    .muted{color:var(--muted2); font-size:12px}
    .divider{height:1px; background: rgba(255,255,255,.08); margin:12px 0}
    .qbox{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius: 14px;
      padding:12px;
    }
    .qtitle{font-weight:800; font-size:14px; margin:0 0 8px}
    .qhelp{color:var(--muted2); font-size:12px; margin:0 0 10px}
    .opt{display:flex; gap:8px; flex-wrap:wrap}
    .opt button{flex: 1 1 auto; min-width: 130px}
    .smallnote{font-size:12px; color:var(--muted2); margin-top:8px}
    table{width:100%; border-collapse: collapse; font-size:12px}
    th,td{border-bottom:1px solid rgba(255,255,255,.08); padding:9px 8px; vertical-align:top}
    th{color:var(--muted); text-align:left; font-weight:800; font-size:12px}
    tr:hover td{background: rgba(255,255,255,.02)}
    .status{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; font-weight:800; font-size:11px;
      border:1px solid rgba(255,255,255,.14);
    }
    .status.ok{border-color: rgba(57,217,138,.35); background: rgba(57,217,138,.10)}
    .status.warn{border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.10)}
    .status.bad{border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.10)}
    .status.info{border-color: rgba(106,168,255,.35); background: rgba(106,168,255,.10)}
    .kpi{
      display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;
    }
    @media (max-width: 1020px){
      .kpi{grid-template-columns: repeat(2, 1fr)}
    }
    .kpi .box{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding:12px;
    }
    .kpi .box .n{font-size:20px; font-weight:900}
    .kpi .box .t{font-size:12px; color:var(--muted2)}
    .twoCols{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 800px){ .twoCols{grid-template-columns: 1fr} }
    .footer{
      margin-top:16px; color:var(--muted2); font-size:12px; opacity:.9;
      padding: 8px 2px 18px;
    }
  </style>
</head>

<body>
<header>
  <h1>D√©mo ‚Äî Arbre de d√©cision (questions d‚Äôusage) ‚Üí pr√©s√©lection ‚Üí filtres techniques (20 produits fictifs)</h1>
  <div class="sub">Copie ce fichier dans un d√©p√¥t GitHub Pages (ex: <span style="font-family:var(--mono)">index.html</span>). Un ‚ÄúBack-office‚Äù int√©gr√© permet d‚Äô√©diter les questions + r√®gles + base produits (JSON).</div>
</header>

<main class="grid">

  <!-- LEFT: QUESTION FLOW -->
  <section class="card" id="flowCard">
    <div class="hd">
      <div class="ttl">Parcours utilisateur</div>
      <div class="pill" id="modePill">Mode : Usager</div>
    </div>
    <div class="bd">

      <div class="row" style="margin-bottom:10px">
        <button class="btn tiny" id="modeUserBtn">Usager (simple)</button>
        <button class="btn tiny secondary" id="modeExpertBtn">Expert (avanc√©)</button>
        <button class="btn tiny secondary" id="resetBtn" title="R√©initialiser toutes les r√©ponses">R√©initialiser</button>
      </div>

      <div id="progressTags"></div>

      <div class="qbox" id="questionBox">
        <!-- dynamic -->
      </div>

      <div class="divider"></div>

      <div class="kpi">
        <div class="box">
          <div class="n" id="clarityScore">‚Äî</div>
          <div class="t">Score clart√©</div>
        </div>
        <div class="box">
          <div class="n" id="priorityLevel">‚Äî</div>
          <div class="t">Priorit√©</div>
        </div>
        <div class="box">
          <div class="n" id="needsExpert">‚Äî</div>
          <div class="t">Escalade sp√©cialiste</div>
        </div>
        <div class="box">
          <div class="n" id="shortlistCount">‚Äî</div>
          <div class="t">Produits pr√©s√©lectionn√©s</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="qbox">
        <p class="qtitle" style="margin-bottom:6px">Sortie : Cahier des charges (g√©n√©r√©)</p>
        <p class="qhelp">R√©sum√© ‚Äúcommercial / sp√©cialiste‚Äù. Copiable en 1 clic.</p>
        <div class="row" style="margin-bottom:10px">
          <button class="btn tiny ok" id="copyCdcBtn">Copier</button>
          <button class="btn tiny secondary" id="downloadCdcBtn">T√©l√©charger .txt</button>
        </div>
        <textarea id="cdcText" readonly></textarea>
        <div class="smallnote">Astuce : ajoute ce bloc dans ta page ‚Äúcontact sp√©cialiste‚Äù pour pr√©-remplir la demande.</div>
      </div>

    </div>
  </section>

  <!-- RIGHT: RESULTS + FILTERS + BACK OFFICE -->
  <section class="card">
    <div class="hd">
      <div class="ttl">R√©sultats & filtres</div>
      <div class="pill" id="resultPill">Liste produits</div>
    </div>
    <div class="bd">

      <div class="twoCols">
        <div class="qbox">
          <p class="qtitle">Filtres techniques (niveau 2)</p>
          <p class="qhelp">Ces filtres r√©duisent la pr√©s√©lection √† tout moment, sans r√©introduire des produits exclus par l‚Äôarbre.</p>

          <div class="field">
            <label>CMU minimale (tonnes)</label>
            <input type="range" min="0" max="5" step="0.25" value="0" id="filterCmu" />
            <div class="muted">Seuil : <b id="filterCmuVal">0</b> T</div>
          </div>

          <div class="field">
            <label>Niveau d‚Äôinstallation</label>
            <select id="filterInstall">
              <option value="">Tous</option>
              <option value="simple">Simple</option>
              <option value="standard">Standard</option>
              <option value="complexe">Complexe</option>
              <option value="etude">√âtude requise</option>
            </select>
          </div>

          <div class="field">
            <label>Source d‚Äô√©nergie (appareils)</label>
            <select id="filterEnergy">
              <option value="">Toutes</option>
              <option value="manuel">Manuel</option>
              <option value="electrique">√âlectrique</option>
              <option value="pneumatique">Pneumatique</option>
            </select>
          </div>

          <div class="field">
            <label>D√©lai</label>
            <select id="filterDelay">
              <option value="">Tous</option>
              <option value="stock">Stock</option>
              <option value="court">Court</option>
              <option value="long">Long</option>
            </select>
          </div>

          <div class="field">
            <label>Budget</label>
            <select id="filterBudget">
              <option value="">Tous</option>
              <option value="‚Ç¨">‚Ç¨</option>
              <option value="‚Ç¨‚Ç¨">‚Ç¨‚Ç¨</option>
              <option value="‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨</option>
            </select>
          </div>

          <div class="row">
            <button class="btn tiny secondary" id="clearFiltersBtn">R√©initialiser filtres</button>
          </div>
        </div>

        <div class="qbox">
          <p class="qtitle">Alerte & restrictions</p>
          <p class="qhelp">Messages ‚Äúcanal expert‚Äù d√©clench√©s par les r√©ponses (ATEX, salin, excentr√©, 4 points, etc.).</p>
          <div id="alertsBox"></div>
          <div class="divider"></div>
          <p class="qtitle" style="margin-bottom:6px">Actions</p>
          <div class="row">
            <button class="btn tiny" id="showSupportsBtn">Supports</button>
            <button class="btn tiny" id="showDevicesBtn">Appareils</button>
            <button class="btn tiny" id="showAccessoriesBtn">Accessoires</button>
            <button class="btn tiny secondary" id="showAllBtn">Tout</button>
          </div>
          <div class="smallnote">Le listing est filtrable par ‚Äúbrique‚Äù : Support / Appareil / Accessoire.</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="qbox">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div>
            <div class="qtitle" style="margin:0">Tableau produits (pr√©s√©lection + filtres)</div>
            <div class="qhelp" style="margin:6px 0 0">Statut : Compatible / √Ä v√©rifier / Incompatible (selon r√®gles & restrictions).</div>
          </div>
          <div class="row">
            <button class="btn tiny secondary" id="exportJsonBtn">Exporter JSON (base + config)</button>
          </div>
        </div>

        <div style="overflow:auto; border-radius: 12px; border:1px solid rgba(255,255,255,.10); margin-top:10px">
          <table id="productsTable">
            <thead>
              <tr>
                <th>Produit</th>
                <th>Brique</th>
                <th>CMU</th>
                <th>Hauteur max</th>
                <th>√ânergie</th>
                <th>Environnements</th>
                <th>Installation</th>
                <th>D√©lai</th>
                <th>Budget</th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody><!-- dynamic --></tbody>
          </table>
        </div>
      </div>

      <div class="divider"></div>

      <!-- BACK OFFICE -->
      <div class="card" style="box-shadow:none; border-radius: var(--radius); border:1px dashed rgba(255,255,255,.18)">
        <div class="hd">
          <div class="ttl">Back-office (param√©trage JSON)</div>
          <div class="pill">Questions ‚Ä¢ r√®gles ‚Ä¢ base produits</div>
        </div>
        <div class="bd">
          <p class="muted" style="margin-top:0">
            Modifie le JSON ci-dessous puis clique <b>Appliquer</b>. Tout est embarqu√© dans ce fichier HTML.
          </p>
          <div class="row" style="margin-bottom:10px">
            <button class="btn ok" id="applyConfigBtn">Appliquer</button>
            <button class="btn secondary" id="restoreDefaultBtn">Restaurer d√©faut</button>
          </div>
          <textarea id="configEditor"></textarea>
          <div class="footer">
            ‚úÖ D√©mo autonome ‚Ä¢ ‚úÖ GitHub Pages compatible ‚Ä¢ ‚úÖ 20 produits fictifs (5 supports, 7 appareils, 8 accessoires) ‚Ä¢
            ‚ö†Ô∏è Logique simplifi√©e volontairement (√† adapter √† ta base r√©elle / r√®gles plus fines).
          </div>
        </div>
      </div>

    </div>
  </section>
</main>

<script>
/**
 * =========================
 * 1) DEFAULT CONFIG (JSON)
 * =========================
 * - 20 produits fictifs
 * - questions simples "usager" + questions "expert"
 * - r√®gles minimales pour statuts + alertes
 */
const DEFAULT_CONFIG = {
  meta: {
    siteName: "D√©mo Levage",
    specialistCTA: "üìû Contacter un sp√©cialiste Mat√©riel Levage",
    currency: "EUR"
  },

  // --- Products (20) ---
  products: [
    // 5 SUPPORTS
    { id:"SUP-01", name:"Portique mobile aluminium", brick:"support", cmuT:2.0, heightMaxM:5, energy:"", env:["interieur","exterieur"], install:"standard", delay:"stock", budget:"‚Ç¨‚Ç¨", notes:"Sol plan requis, usage r√©gulier."},
    { id:"SUP-02", name:"Portique acier fixe", brick:"support", cmuT:3.2, heightMaxM:8, energy:"", env:["interieur","exterieur","salin"], install:"complexe", delay:"court", budget:"‚Ç¨‚Ç¨‚Ç¨", notes:"Fixations / ancrages √† valider."},
    { id:"SUP-03", name:"Potence murale", brick:"support", cmuT:1.0, heightMaxM:4, energy:"", env:["interieur"], install:"complexe", delay:"court", budget:"‚Ç¨‚Ç¨", notes:"Structure porteuse √† valider."},
    { id:"SUP-04", name:"Poutre de roulement (profil)", brick:"support", cmuT:5.0, heightMaxM:10, energy:"", env:["interieur"], install:"etude", delay:"long", budget:"‚Ç¨‚Ç¨‚Ç¨", notes:"√âtude structure obligatoire."},
    { id:"SUP-05", name:"Portique inox environnement salin", brick:"support", cmuT:2.0, heightMaxM:6, energy:"", env:["exterieur","salin"], install:"complexe", delay:"long", budget:"‚Ç¨‚Ç¨‚Ç¨", notes:"Con√ßu pour zones expos√©es (salinit√©)."},
    // 7 APPAREILS
    { id:"APP-01", name:"Palan manuel √† cha√Æne", brick:"appareil", cmuT:2.0, heightMaxM:3, energy:"manuel", env:["interieur","exterieur"], install:"simple", delay:"stock", budget:"‚Ç¨", notes:"Pour usage ponctuel / faible cadence."},
    { id:"APP-02", name:"Palan √©lectrique 230V", brick:"appareil", cmuT:2.0, heightMaxM:6, energy:"electrique", env:["interieur"], install:"standard", delay:"stock", budget:"‚Ç¨‚Ç¨", notes:"Usage r√©gulier, hors environnement salin."},
    { id:"APP-03", name:"Palan √©lectrique 400V industriel", brick:"appareil", cmuT:3.2, heightMaxM:8, energy:"electrique", env:["interieur","exterieur"], install:"standard", delay:"court", budget:"‚Ç¨‚Ç¨‚Ç¨", notes:"Pour cadence plus √©lev√©e."},
    { id:"APP-04", name:"Treuil √©lectrique (traction)", brick:"appareil", cmuT:1.0, heightMaxM:0, energy:"electrique", env:["interieur","exterieur"], install:"standard", delay:"stock", budget:"‚Ç¨‚Ç¨", notes:"Traction / d√©placement, pas levage vertical continu."},
    { id:"APP-05", name:"Chariot porte-palan", brick:"appareil", cmuT:2.0, heightMaxM:0, energy:"manuel", env:["interieur","exterieur"], install:"standard", delay:"stock", budget:"‚Ç¨", notes:"Translation sur poutre/rail compatible."},
    { id:"APP-06", name:"Palan pneumatique (ATEX)", brick:"appareil", cmuT:2.0, heightMaxM:6, energy:"pneumatique", env:["atex","exterieur"], install:"complexe", delay:"long", budget:"‚Ç¨‚Ç¨‚Ç¨", notes:"Pour zones ATEX, n√©cessite air comprim√©."},
    { id:"APP-07", name:"Palan √©lectrique inox (salin)", brick:"appareil", cmuT:2.0, heightMaxM:6, energy:"electrique", env:["exterieur","salin"], install:"complexe", delay:"long", budget:"‚Ç¨‚Ç¨‚Ç¨", notes:"Protection anti-corrosion renforc√©e."},
    // 8 ACCESSOIRES
    { id:"ACC-01", name:"√âlingue cha√Æne 2 brins (G80)", brick:"accessoire", cmuT:2.0, heightMaxM:0, energy:"", env:["interieur","exterieur"], install:"simple", delay:"stock", budget:"‚Ç¨‚Ç¨", notes:"Supporte mieux abrasion / ar√™tes."},
    { id:"ACC-02", name:"√âlingue textile plate 2T", brick:"accessoire", cmuT:2.0, heightMaxM:0, energy:"", env:["interieur"], install:"simple", delay:"stock", budget:"‚Ç¨", notes:"Interdit ar√™tes vives sans protection."},
    { id:"ACC-03", name:"Manille lyre HR 3,25T", brick:"accessoire", cmuT:3.25, heightMaxM:0, energy:"", env:["interieur","exterieur"], install:"simple", delay:"stock", budget:"‚Ç¨", notes:"V√©rifier efforts lat√©raux."},
    { id:"ACC-04", name:"Palonnier 4 points 2T", brick:"accessoire", cmuT:2.0, heightMaxM:0, energy:"", env:["interieur","exterieur"], install:"standard", delay:"court", budget:"‚Ç¨‚Ç¨‚Ç¨", notes:"R√©partition des efforts, id√©al charges excentr√©es."},
    { id:"ACC-05", name:"Anneaux de levage orientables (x4)", brick:"accessoire", cmuT:2.0, heightMaxM:0, energy:"", env:["interieur","exterieur"], install:"standard", delay:"stock", budget:"‚Ç¨‚Ç¨", notes:"Montage / couple de serrage √† respecter."},
    { id:"ACC-06", name:"Ventouse double (non ATEX)", brick:"accessoire", cmuT:0.5, heightMaxM:0, energy:"", env:["interieur"], install:"standard", delay:"court", budget:"‚Ç¨‚Ç¨", notes:"Surface propre, non poreuse."},
    { id:"ACC-07", name:"Kit protection d‚Äôar√™tes (UHMWPE)", brick:"accessoire", cmuT:0, heightMaxM:0, energy:"", env:["interieur","exterieur"], install:"simple", delay:"stock", budget:"‚Ç¨", notes:"√Ä utiliser avec textile pour ar√™tes."},
    { id:"ACC-08", name:"√âlingue cha√Æne inox 4 brins", brick:"accessoire", cmuT:2.0, heightMaxM:0, energy:"", env:["exterieur","salin"], install:"standard", delay:"long", budget:"‚Ç¨‚Ç¨‚Ç¨", notes:"Pour environnements corrosifs + 4 points."}
  ],

  // --- Question flows (two modes) ---
  flows: {
    user: [
      {
        id:"op",
        title:"Que devez-vous faire avec la charge ?",
        help:"Choisissez l‚Äôop√©ration principale (sans jargon).",
        type:"single",
        answers:[
          { value:"arrimage", label:"Maintenir une charge pendant un transport" },
          { value:"manut", label:"D√©placer au sol (hauteur insignifiante)" },
          { value:"epi", label:"Prot√©ger les op√©rateurs (EPI)" },
          { value:"levage", label:"Lever une charge (charge suspendue)" }
        ],
        weight: 15
      },
      {
        id:"move",
        title:"Apr√®s levage, devez-vous d√©placer la charge horizontalement ?",
        help:"Ex : d√©placer sur un point fixe ou sur plusieurs emplacements.",
        type:"single",
        answers:[
          { value:"none", label:"Non, uniquement lever / descendre" },
          { value:"one", label:"Oui, sur un point fixe" },
          { value:"multi", label:"Oui, sur plusieurs emplacements" }
        ],
        showIf: { op:["levage"] },
        weight: 10
      },
      {
        id:"env",
        title:"O√π se d√©roule l‚Äôop√©ration ?",
        help:"L‚Äôenvironnement conditionne fortement le choix (corrosion, ATEX‚Ä¶).",
        type:"multi",
        answers:[
          { value:"interieur", label:"Int√©rieur" },
          { value:"exterieur", label:"Ext√©rieur" },
          { value:"salin", label:"Ext√©rieur expos√© (air marin / salin)" },
          { value:"atex", label:"Zone ATEX" }
        ],
        showIf: { op:["levage"] },
        weight: 15
      },
      {
        id:"weightKnown",
        title:"Connaissez-vous le poids r√©el de la charge ?",
        help:"Le poids r√©el conditionne la s√©lection. En cas de doute, escalade.",
        type:"single",
        answers:[
          { value:"yes", label:"Oui, pr√©cis√©ment" },
          { value:"est", label:"Estimation" },
          { value:"no", label:"Non / incertain" }
        ],
        showIf: { op:["levage"] },
        weight: 20
      },
      {
        id:"weightT",
        title:"Quel est le poids de la charge (tonnes) ?",
        help:"Saisissez une valeur. (Ex : 1.8)",
        type:"number",
        min: 0, max: 10, step: 0.1, placeholder: "ex : 1.8",
        showIf: { op:["levage"], weightKnown:["yes","est"] },
        weight: 15
      },
      {
        id:"heightM",
        title:"Quelle est la hauteur maximale de levage (m) ?",
        help:"Ex : 4. (Impact direct sur le choix de l‚Äôappareil.)",
        type:"number",
        min: 0, max: 50, step: 0.5, placeholder: "ex : 4",
        showIf: { op:["levage"] },
        weight: 10
      },
      {
        id:"support",
        title:"Disposez-vous d√©j√† d‚Äôun support pour l‚Äôappareil de levage ?",
        help:"Ex : portique, potence, poutre existante‚Ä¶",
        type:"single",
        answers:[
          { value:"yes", label:"Oui" },
          { value:"no", label:"Non" },
          { value:"idk", label:"Je ne sais pas" }
        ],
        showIf: { op:["levage"] },
        weight: 8
      },
      {
        id:"pickPoints",
        title:"Combien de points d‚Äôaccrochage sur la charge ?",
        help:"Ex : 1 point, 2 points, 4 points‚Ä¶",
        type:"single",
        answers:[
          { value:"1", label:"1 point" },
          { value:"2", label:"2 points" },
          { value:"4", label:"4 points" },
          { value:"idk", label:"Je ne sais pas" }
        ],
        showIf: { op:["levage"] },
        weight: 12
      },
      {
        id:"eccentric",
        title:"La charge est-elle √©quilibr√©e pendant le levage ?",
        help:"Si excentr√©e, pr√©voir r√©partition des efforts (palonnier / 4 brins‚Ä¶).",
        type:"single",
        answers:[
          { value:"balanced", label:"Oui, √©quilibr√©e" },
          { value:"eccStable", label:"Non, excentr√©e mais stable" },
          { value:"eccUnstable", label:"Non, excentr√©e instable" },
          { value:"idk", label:"Je ne sais pas" }
        ],
        showIf: { op:["levage"] },
        weight: 10
      }
    ],

    expert: [
      // Expert adds "energy preference" and "install level"
      {
        id:"energyPref",
        title:"Pr√©f√©rence d‚Äô√©nergie pour l‚Äôappareil ?",
        help:"Optionnel : oriente la pr√©s√©lection des appareils.",
        type:"single",
        answers:[
          { value:"", label:"Aucune pr√©f√©rence" },
          { value:"manuel", label:"Manuel" },
          { value:"electrique", label:"√âlectrique" },
          { value:"pneumatique", label:"Pneumatique" }
        ],
        showIf: { op:["levage"] },
        weight: 5
      },
      {
        id:"installPref",
        title:"Niveau d‚Äôinstallation acceptable ?",
        help:"Optionnel : filtrage selon les contraintes d‚Äôint√©gration.",
        type:"single",
        answers:[
          { value:"", label:"Peu importe" },
          { value:"simple", label:"Simple" },
          { value:"standard", label:"Standard" },
          { value:"complexe", label:"Complexe" },
          { value:"etude", label:"√âtude requise acceptable" }
        ],
        showIf: { op:["levage"] },
        weight: 5
      }
    ]
  },

  // --- Rules (simplified) ---
  rules: {
    // Basic restrictions/alerts based on answers
    restrictions: [
      {
        id:"R-ATEX",
        when: (a)=> a.env?.includes("atex"),
        message: "Zone ATEX d√©tect√©e : uniquement des √©quipements compatibles ATEX (ex : palan pneumatique ATEX).",
        level: "bad"
      },
      {
        id:"R-SALIN",
        when: (a)=> a.env?.includes("salin"),
        message: "Environnement salin : privil√©gier inox / protections anticorrosion + maintenance renforc√©e.",
        level: "warn"
      },
      {
        id:"R-4PTS",
        when: (a)=> a.pickPoints==="4",
        message: "Accrochage 4 points : pr√©voir accessoire de r√©partition (palonnier 4 points / 4 brins) + v√©rifications montage.",
        level: "info"
      },
      {
        id:"R-ECC",
        when: (a)=> ["eccStable","eccUnstable"].includes(a.eccentric),
        message: "Charge excentr√©e : risques de surcharges locales ‚Üí r√©partition des efforts obligatoire (palonnier / accessoires adapt√©s).",
        level: "warn"
      },
      {
        id:"R-MULTI",
        when: (a)=> a.move==="multi",
        message: "D√©placement sur plusieurs emplacements : efforts dynamiques potentiels ‚Üí surdimensionnement / contr√¥les accrus recommand√©s.",
        level: "info"
      },
      {
        id:"R-NOWEIGHT",
        when: (a)=> a.weightKnown==="no",
        message: "Poids inconnu : impossible de valider une s√©lection s√ªre ‚Üí escalade sp√©cialiste recommand√©e.",
        level: "bad"
      },
      {
        id:"R-UNSTABLE",
        when: (a)=> a.eccentric==="eccUnstable",
        message: "Charge excentr√©e instable : configuration hors standard ‚Üí √©tude / sp√©cialiste indispensable.",
        level: "bad"
      }
    ],

    // Determine whether escalation to specialist is required
    needsSpecialist: (a)=>{
      if(a.op!=="levage") return false;
      if(a.weightKnown==="no") return true;
      if(a.support==="idk") return true;
      if(a.eccentric==="eccUnstable") return true;
      if(a.env?.includes("atex")) return true;
      // If 4 points + excentr√© => recommend specialist
      if(a.pickPoints==="4" && ["eccStable","eccUnstable"].includes(a.eccentric)) return true;
      return false;
    },

    // Score clarity
    clarity: (a)=>{
      if(a.op!=="levage") return 55;
      // scoring by completeness
      let score = 0;
      const add = (x)=> score += x;

      // main elements
      if(a.op==="levage") add(15);
      if(a.move) add(6);
      if(a.env && a.env.length) add(10);

      if(a.weightKnown==="yes") add(18);
      else if(a.weightKnown==="est") add(10);
      else add(0);

      if(a.weightT!=null && a.weightT!=="") add(12);
      if(a.heightM!=null && a.heightM!=="") add(10);

      if(a.support==="yes") add(8);
      else if(a.support==="no") add(6);
      else add(2);

      if(a.pickPoints && a.pickPoints!=="idk") add(10);
      if(a.eccentric && a.eccentric!=="idk") add(9);

      // cap
      score = Math.max(0, Math.min(100, Math.round(score)));
      return score;
    },

    // Priority label
    priority: (score, needs)=>{
      if(needs) return "Sp√©cialiste";
      if(score>=80) return "Haute";
      if(score>=60) return "Standard";
      if(score>=40) return "Compl√©ments";
      return "Faible";
    }
  }
};

/**
 * =========================
 * 2) APP STATE
 * =========================
 */
let CONFIG = structuredClone(DEFAULT_CONFIG);
let mode = "user"; // "user" or "expert"
let currentIdx = 0;

const answers = {}; // { [questionId]: value | array | number }
let listingBrickFilter = ""; // "", "support", "appareil", "accessoire"
const ui = {};

/**
 * =========================
 * 3) HELPERS
 * =========================
 */
function $(id){ return document.getElementById(id); }

function safeParseJson(text){
  try { return { ok:true, value: JSON.parse(text) }; }
  catch(e){ return { ok:false, error: e.message }; }
}

function isQuestionVisible(q){
  if(!q.showIf) return true;
  // q.showIf: { someQuestionId: ["allowed", "values"] }
  for(const [k, allowed] of Object.entries(q.showIf)){
    const v = answers[k];
    if(Array.isArray(v)){
      // any overlap
      const ok = v.some(x => allowed.includes(x));
      if(!ok) return false;
    } else {
      if(!allowed.includes(String(v))) return false;
    }
  }
  return true;
}

function getFlowQuestions(){
  const base = CONFIG.flows.user;
  const extra = (mode==="expert") ? CONFIG.flows.expert : [];
  // Expert questions appear after base flow (simple approach)
  return [...base, ...extra].filter(isQuestionVisible);
}

function formatEnv(envArr){
  if(!envArr || !envArr.length) return "‚Äî";
  const map = { interieur:"Int√©rieur", exterieur:"Ext√©rieur", salin:"Salin", atex:"ATEX" };
  return envArr.map(e => map[e] || e).join(", ");
}

function statusChip(status){
  const cls = status==="Compatible" ? "ok" : (status==="√Ä v√©rifier" ? "warn" : (status==="Incompatible" ? "bad" : "info"));
  return `<span class="status ${cls}">${status}</span>`;
}

function clampNum(n, min, max){
  const x = Number(n);
  if(Number.isNaN(x)) return null;
  return Math.max(min, Math.min(max, x));
}

/**
 * =========================
 * 4) CORE LOGIC: PRES√âLECTION
 * =========================
 * - Filter by user answers (usage/env/constraints)
 * - Then apply "technical filters"
 * - Provide status per product
 */
function computeAlerts(){
  const out = [];
  for(const r of CONFIG.rules.restrictions){
    try{
      if(r.when(answers)){
        out.push({id:r.id, message:r.message, level:r.level});
      }
    }catch(e){}
  }
  return out;
}

function computeBaseEligibility(p){
  // returns {status, reasons[]}
  const reasons = [];
  let status = "Compatible";

  if(answers.op && answers.op!=="levage"){
    // For this demo, we keep listing anyway but note it
    status = "√Ä v√©rifier";
    reasons.push("D√©mo orient√©e Levage : branche non-levage.");
  }

  // Environment compatibility
  const env = answers.env || [];
  if(env.includes("atex")){
    // Only products with atex in env allowed
    if(!p.env.includes("atex")){
      status = "Incompatible";
      reasons.push("Incompatible ATEX.");
    }
  }
  if(env.includes("salin")){
    // Prefer salin-capable; others become "√Ä v√©rifier" or incompatible for some types
    if(!p.env.includes("salin") && p.brick !== "accessoire"){
      // Supports/appareils non salin => verify
      if(status!=="Incompatible"){
        status = "√Ä v√©rifier";
        reasons.push("Environnement salin : protection anticorrosion √† v√©rifier.");
      }
    }
  }
  if(env.includes("exterieur")){
    if(!p.env.includes("exterieur") && !p.env.includes("atex") && !p.env.includes("salin")){
      if(status!=="Incompatible"){
        status = "√Ä v√©rifier";
        reasons.push("Usage ext√©rieur : compatibilit√© √† confirmer.");
      }
    }
  }
  if(env.includes("interieur")){
    // interior generally ok
  }

  // Height constraint (mostly devices/supports)
  const h = (answers.heightM!=null && answers.heightM!=="") ? Number(answers.heightM) : null;
  if(h!=null && !Number.isNaN(h) && h>0){
    // for devices: need heightMaxM >= height
    if(p.brick==="appareil"){
      if(p.heightMaxM>0 && p.heightMaxM < h){
        status = "Incompatible";
        reasons.push("Hauteur max insuffisante.");
      }
    }
    // supports: ensure support heightMaxM >= height (simplified)
    if(p.brick==="support"){
      if(p.heightMaxM>0 && p.heightMaxM < h){
        status = "Incompatible";
        reasons.push("Hauteur support insuffisante.");
      }
    }
  }

  // Weight / CMU check (simplified)
  const wKnown = answers.weightKnown;
  const w = (answers.weightT!=null && answers.weightT!=="") ? Number(answers.weightT) : null;
  if(wKnown==="yes" || wKnown==="est"){
    if(w!=null && !Number.isNaN(w) && w>0){
      // For products with cmuT = 0 => ignore CMU (e.g., protection)
      if(p.cmuT>0 && p.cmuT < w){
        status = "Incompatible";
        reasons.push("CMU insuffisante vs poids charge.");
      } else if(p.cmuT>0 && p.cmuT >= w){
        // ok
      }
    }
  } else if(wKnown==="no"){
    // can't validate CMU
    if(status!=="Incompatible"){
      status = "√Ä v√©rifier";
      reasons.push("Poids inconnu : CMU non validable.");
    }
  }

  // 4 points + excentric => promote palonnier/4 brins, warn others
  if(answers.pickPoints==="4"){
    if(p.brick==="accessoire"){
      const needsDistribution = ["eccStable","eccUnstable"].includes(answers.eccentric);
      if(needsDistribution){
        const isDistributor = /Palonnier 4 points|4 brins/i.test(p.name);
        if(!isDistributor && p.cmuT>0){
          if(status!=="Incompatible"){
            status = "√Ä v√©rifier";
            reasons.push("4 points + excentr√© : pr√©voir r√©partition (palonnier/4 brins) ‚Äî accessoire √† confirmer.");
          }
        }
      }
    }
  }

  // Energy preference (expert)
  if(mode==="expert" && answers.energyPref){
    if(p.brick==="appareil" && answers.energyPref!=="" && p.energy!==answers.energyPref){
      // not incompatible, but downgrade to "√Ä v√©rifier"
      if(status!=="Incompatible"){
        status = "√Ä v√©rifier";
        reasons.push("Pr√©f√©rence √©nergie : ne correspond pas au filtre.");
      }
    }
  }

  // Installation preference (expert)
  if(mode==="expert" && answers.installPref){
    if(answers.installPref!=="" && p.install!==answers.installPref){
      if(status!=="Incompatible"){
        status = "√Ä v√©rifier";
        reasons.push("Niveau d‚Äôinstallation : ne correspond pas √† la pr√©f√©rence.");
      }
    }
  }

  return { status, reasons };
}

function applyTechnicalFilters(items){
  const cmuMin = Number(ui.filterCmu.value);
  const install = ui.filterInstall.value;
  const energy = ui.filterEnergy.value;
  const delay = ui.filterDelay.value;
  const budget = ui.filterBudget.value;

  return items.filter(it=>{
    const p = it.product;
    // Brick filter
    if(listingBrickFilter && p.brick!==listingBrickFilter) return false;

    // CMU min
    if(p.cmuT>0 && p.cmuT < cmuMin) return false;
    // install
    if(install && p.install!==install) return false;
    // energy (only for devices, but allow filtering to exclude devices not matching; for others, keep)
    if(energy){
      if(p.brick==="appareil" && p.energy!==energy) return false;
      if(p.brick!=="appareil") {
        // keep non devices regardless of energy filter
      }
    }
    // delay/budget
    if(delay && p.delay!==delay) return false;
    if(budget && p.budget!==budget) return false;

    return true;
  });
}

function computeListing(){
  const base = CONFIG.products.map(p=>{
    const elig = computeBaseEligibility(p);
    return { product:p, status: elig.status, reasons: elig.reasons };
  });

  // Sort: Compatible first, then √Ä v√©rifier, then Incompatible
  const rank = { "Compatible":0, "√Ä v√©rifier":1, "Incompatible":2 };
  base.sort((a,b)=> (rank[a.status]-rank[b.status]) || a.product.brick.localeCompare(b.product.brick) || a.product.name.localeCompare(b.product.name));

  // Apply UI filters
  const filtered = applyTechnicalFilters(base);
  return { base, filtered };
}

/**
 * =========================
 * 5) RENDER
 * =========================
 */
function renderProgressTags(flow){
  const tags = [];
  for(const q of flow){
    const v = answers[q.id];
    if(v==null || v==="" || (Array.isArray(v) && v.length===0)) continue;
    let valTxt = "";
    if(q.type==="multi"){
      valTxt = v.map(x=>{
        const a = q.answers.find(y=>y.value===x);
        return a ? a.label : x;
      }).join(", ");
    } else if(q.type==="single"){
      const a = q.answers.find(y=>y.value===v);
      valTxt = a ? a.label : String(v);
    } else if(q.type==="number"){
      valTxt = String(v);
    }
    tags.push(`<span class="tag info"><b>${q.title.split("?")[0]}</b> : ${escapeHtml(valTxt)}</span>`);
  }
  ui.progressTags.innerHTML = tags.join("") || `<span class="muted">R√©ponds aux questions pour g√©n√©rer une pr√©s√©lection.</span>`;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
}

function renderQuestion(flow){
  if(flow.length===0){
    ui.questionBox.innerHTML = `<p class="qtitle">Aucune question visible</p>`;
    return;
  }
  currentIdx = Math.max(0, Math.min(currentIdx, flow.length-1));
  const q = flow[currentIdx];

  let body = `<p class="qtitle">${escapeHtml(q.title)}</p>
              <p class="qhelp">${escapeHtml(q.help || "")}</p>`;

  if(q.type==="single"){
    body += `<div class="opt">` + q.answers.map(a=>{
      const active = answers[q.id]===a.value;
      return `<button class="btn ${active?'ok':''}" data-q="${q.id}" data-v="${escapeHtml(a.value)}">${escapeHtml(a.label)}</button>`;
    }).join("") + `</div>`;
  }

  if(q.type==="multi"){
    const cur = Array.isArray(answers[q.id]) ? answers[q.id] : [];
    body += `<div class="opt">` + q.answers.map(a=>{
      const active = cur.includes(a.value);
      return `<button class="btn ${active?'ok':''}" data-q="${q.id}" data-v="${escapeHtml(a.value)}">${active?'‚úì ':''}${escapeHtml(a.label)}</button>`;
    }).join("") + `</div>
    <div class="smallnote">Clique pour activer/d√©sactiver plusieurs choix.</div>`;
  }

  if(q.type==="number"){
    const v = (answers[q.id]!=null) ? answers[q.id] : "";
    body += `<div class="field">
              <input type="number" step="${q.step||1}" min="${q.min||0}" max="${q.max||9999}" placeholder="${escapeHtml(q.placeholder||'')}"
                     id="num_${q.id}" value="${escapeHtml(v)}" />
            </div>
            <div class="row">
              <button class="btn tiny" data-numsave="${q.id}">Valider</button>
            </div>`;
  }

  body += `<div class="divider"></div>
           <div class="row">
             <button class="btn tiny secondary" ${currentIdx===0?'disabled style="opacity:.5;cursor:not-allowed"':''} id="prevBtn">‚Üê Pr√©c√©dent</button>
             <button class="btn tiny" ${currentIdx===flow.length-1?'disabled style="opacity:.5;cursor:not-allowed"':''} id="nextBtn">Suivant ‚Üí</button>
           </div>
           <div class="smallnote">Question ${currentIdx+1} / ${flow.length}</div>`;

  ui.questionBox.innerHTML = body;

  // attach events
  ui.questionBox.querySelectorAll("button[data-q]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const qid = btn.getAttribute("data-q");
      const val = btn.getAttribute("data-v");
      const question = flow.find(x=>x.id===qid);
      if(question.type==="multi"){
        const cur = Array.isArray(answers[qid]) ? answers[qid] : [];
        const idx = cur.indexOf(val);
        if(idx>=0) cur.splice(idx,1); else cur.push(val);
        answers[qid] = cur;
      } else {
        answers[qid] = val;
      }
      // if answer changes, flow visibility may change => recompute idx if needed
      rerenderAll(true);
    });
  });

  ui.questionBox.querySelectorAll("button[data-numsave]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const qid = btn.getAttribute("data-numsave");
      const inp = ui.questionBox.querySelector(`#num_${CSS.escape(qid)}`);
      const question = flow.find(x=>x.id===qid);
      const n = clampNum(inp.value, question.min ?? -Infinity, question.max ?? Infinity);
      answers[qid] = (n==null ? "" : n);
      rerenderAll(false);
    });
  });

  const prev = ui.questionBox.querySelector("#prevBtn");
  const next = ui.questionBox.querySelector("#nextBtn");
  if(prev) prev.addEventListener("click", ()=>{ currentIdx--; rerenderAll(false); });
  if(next) next.addEventListener("click", ()=>{ currentIdx++; rerenderAll(false); });
}

function renderAlerts(){
  const alerts = computeAlerts();
  if(alerts.length===0){
    ui.alertsBox.innerHTML = `<span class="muted">Aucune alerte pour l‚Äôinstant.</span>`;
    return;
  }
  const mapLevel = { ok:"ok", warn:"warn", bad:"bad", info:"info" };
  ui.alertsBox.innerHTML = alerts.map(a=>{
    return `<div class="tag ${mapLevel[a.level]||'info'}" style="display:flex; margin:0 0 8px 0; border-radius:14px">
              <b style="min-width:70px">${escapeHtml(a.id)}</b>
              <span>${escapeHtml(a.message)}</span>
            </div>`;
  }).join("");
}

function renderKPIs(listing){
  const needs = CONFIG.rules.needsSpecialist(answers);
  const score = CONFIG.rules.clarity(answers);
  const prio = CONFIG.rules.priority(score, needs);

  ui.clarityScore.textContent = score;
  ui.priorityLevel.textContent = prio;
  ui.needsExpert.textContent = needs ? "Oui" : "Non";
  ui.shortlistCount.textContent = listing.filtered.length;

  // mode pill
  ui.modePill.textContent = `Mode : ${mode==="user" ? "Usager" : "Expert"}`;
}

function renderTable(listing){
  const tbody = ui.productsTable.querySelector("tbody");
  const rows = listing.filtered.map(it=>{
    const p = it.product;
    const envTxt = formatEnv(p.env);
    const cmuTxt = p.cmuT>0 ? `${p.cmuT.toFixed(2)} T`.replace(".00","") : "‚Äî";
    const hTxt = p.heightMaxM>0 ? `${p.heightMaxM} m` : "‚Äî";
    const energy = p.energy ? ({manuel:"Manuel", electrique:"√âlec", pneumatique:"Pneuma"}[p.energy] || p.energy) : "‚Äî";
    const inst = ({simple:"Simple", standard:"Standard", complexe:"Complexe", etude:"√âtude"}[p.install] || p.install || "‚Äî");
    const delay = ({stock:"Stock", court:"Court", long:"Long"}[p.delay] || p.delay || "‚Äî");
    const brick = ({support:"Support", appareil:"Appareil", accessoire:"Accessoire"}[p.brick] || p.brick);

    return `<tr title="${escapeHtml((it.reasons||[]).join(" | "))}">
      <td><b>${escapeHtml(p.name)}</b><div class="muted" style="margin-top:4px">${escapeHtml(p.id)} ‚Äî ${escapeHtml(p.notes||"")}</div></td>
      <td>${escapeHtml(brick)}</td>
      <td>${escapeHtml(cmuTxt)}</td>
      <td>${escapeHtml(hTxt)}</td>
      <td>${escapeHtml(energy)}</td>
      <td>${escapeHtml(envTxt)}</td>
      <td>${escapeHtml(inst)}</td>
      <td>${escapeHtml(delay)}</td>
      <td>${escapeHtml(p.budget||"‚Äî")}</td>
      <td>${statusChip(it.status)}</td>
    </tr>`;
  }).join("");

  tbody.innerHTML = rows || `<tr><td colspan="10" class="muted">Aucun produit ne correspond (pr√©s√©lection + filtres). Ajuste les filtres ou r√©ponses.</td></tr>`;
}

function buildCDC(listing){
  const needs = CONFIG.rules.needsSpecialist(answers);
  const score = CONFIG.rules.clarity(answers);
  const prio = CONFIG.rules.priority(score, needs);

  // Summaries
  const env = (answers.env && answers.env.length) ? answers.env.join(", ") : "‚Äî";
  const weightKnown = answers.weightKnown || "‚Äî";
  const weightT = (answers.weightT!=null && answers.weightT!=="") ? `${answers.weightT} T` : "‚Äî";
  const heightM = (answers.heightM!=null && answers.heightM!=="") ? `${answers.heightM} m` : "‚Äî";
  const move = answers.move || "‚Äî";
  const support = answers.support || "‚Äî";
  const pickPoints = answers.pickPoints || "‚Äî";
  const eccentric = answers.eccentric || "‚Äî";

  // Suggest ‚Äúrecommended set‚Äù if possible: pick top compatible per brick
  const topByBrick = { support:null, appareil:null, accessoire:null };
  for(const it of listing.base){
    if(it.status!=="Compatible") continue;
    const b = it.product.brick;
    if(!topByBrick[b]) topByBrick[b] = it.product;
  }

  const alerts = computeAlerts().map(a=>`- [${a.id}] ${a.message}`).join("\n") || "- (aucune)";

  const recSet = `
Ensemble pressenti (si applicable) :
- Support : ${topByBrick.support ? `${topByBrick.support.name} (${topByBrick.support.cmuT}T)` : "‚Äî"}
- Appareil : ${topByBrick.appareil ? `${topByBrick.appareil.name} (${topByBrick.appareil.cmuT}T, H=${topByBrick.appareil.heightMaxM||"‚Äî"}m, √©nergie=${topByBrick.appareil.energy||"‚Äî"})` : "‚Äî"}
- Accessoire : ${topByBrick.accessoire ? `${topByBrick.accessoire.name} (${topByBrick.accessoire.cmuT||"‚Äî"}T)` : "‚Äî"}
`.trim();

  const txt = `
CAHIER DES CHARGES ‚Äî Demande qualifi√©e (d√©mo)
================================================
Score de clart√© : ${score}/100
Priorit√© : ${prio}
Escalade sp√©cialiste : ${needs ? "OUI" : "NON"}

1) Contexte d‚Äôusage (d√©claratif utilisateur)
- Op√©ration : ${answers.op || "‚Äî"}
- D√©placement apr√®s levage : ${move}
- Environnement : ${env}

2) Charge & contraintes
- Poids : ${weightKnown} | Valeur : ${weightT}
- Hauteur max de levage : ${heightM}
- Support existant : ${support}
- Points d‚Äôaccrochage : ${pickPoints}
- Excentration : ${eccentric}

3) Alertes / restrictions d√©tect√©es
${alerts}

4) Pr√©-s√©lection (apr√®s arbre + filtres)
- Total pr√©s√©lectionn√© : ${listing.base.length}
- Total affich√© (apr√®s filtres) : ${listing.filtered.length}

${recSet}

5) Recommandations (g√©n√©riques)
- Installation : respecter le niveau requis, valider structure/support si existant, essais de fonctionnement.
- Maintenance : inspections avant usage + contr√¥les p√©riodiques adapt√©s √† l‚Äôenvironnement (salin/ATEX).
- Restrictions : ne pas utiliser hors CMU/hauteur/conditions environnementales.
- Si doute ou donn√©es manquantes : solliciter un sp√©cialiste du mat√©riel de levage.

${CONFIG.meta.specialistCTA}
`.trim();

  ui.cdcText.value = txt;
}

function rerenderAll(resetQuestionIdxIfVisibilityChanged){
  // recompute flow based on current answers + mode
  const flow = getFlowQuestions();

  // Ensure current question exists
  if(resetQuestionIdxIfVisibilityChanged){
    // If current question becomes invisible, move to nearest visible
    if(currentIdx>=flow.length) currentIdx = flow.length-1;
    currentIdx = Math.max(0, currentIdx);
  }

  renderProgressTags(flow);
  renderQuestion(flow);
  renderAlerts();

  // listing
  const listing = computeListing();
  renderKPIs(listing);
  renderTable(listing);
  buildCDC(listing);
}

/**
 * =========================
 * 6) UI WIRING
 * =========================
 */
function init(){
  // bind ui
  ui.modePill = $("modePill");
  ui.progressTags = $("progressTags");
  ui.questionBox = $("questionBox");
  ui.alertsBox = $("alertsBox");
  ui.clarityScore = $("clarityScore");
  ui.priorityLevel = $("priorityLevel");
  ui.needsExpert = $("needsExpert");
  ui.shortlistCount = $("shortlistCount");
  ui.productsTable = $("productsTable");

  ui.filterCmu = $("filterCmu");
  ui.filterInstall = $("filterInstall");
  ui.filterEnergy = $("filterEnergy");
  ui.filterDelay = $("filterDelay");
  ui.filterBudget = $("filterBudget");
  ui.filterCmuVal = $("filterCmuVal");

  ui.configEditor = $("configEditor");
  ui.configEditor.value = JSON.stringify(DEFAULT_CONFIG, null, 2);

  // Filters events
  const onFilterChange = ()=> {
    ui.filterCmuVal.textContent = ui.filterCmu.value;
    rerenderAll(false);
  };
  ["input","change"].forEach(evt=>{
    ui.filterCmu.addEventListener(evt, onFilterChange);
  });
  ui.filterInstall.addEventListener("change", onFilterChange);
  ui.filterEnergy.addEventListener("change", onFilterChange);
  ui.filterDelay.addEventListener("change", onFilterChange);
  ui.filterBudget.addEventListener("change", onFilterChange);

  $("clearFiltersBtn").addEventListener("click", ()=>{
    ui.filterCmu.value = 0; ui.filterCmuVal.textContent = "0";
    ui.filterInstall.value = ""; ui.filterEnergy.value = "";
    ui.filterDelay.value = ""; ui.filterBudget.value = "";
    rerenderAll(false);
  });

  // Brick filter buttons
  $("showSupportsBtn").addEventListener("click", ()=>{ listingBrickFilter="support"; rerenderAll(false); });
  $("showDevicesBtn").addEventListener("click", ()=>{ listingBrickFilter="appareil"; rerenderAll(false); });
  $("showAccessoriesBtn").addEventListener("click", ()=>{ listingBrickFilter="accessoire"; rerenderAll(false); });
  $("showAllBtn").addEventListener("click", ()=>{ listingBrickFilter=""; rerenderAll(false); });

  // Mode toggle
  $("modeUserBtn").addEventListener("click", ()=>{
    mode = "user";
    // remove expert-only answers to avoid confusion
    delete answers.energyPref;
    delete answers.installPref;
    rerenderAll(true);
  });
  $("modeExpertBtn").addEventListener("click", ()=>{
    mode = "expert";
    rerenderAll(true);
  });

  // Reset
  $("resetBtn").addEventListener("click", ()=>{
    for(const k of Object.keys(answers)) delete answers[k];
    currentIdx = 0;
    rerenderAll(true);
  });

  // Back office
  $("applyConfigBtn").addEventListener("click", ()=>{
    const parsed = safeParseJson(ui.configEditor.value);
    if(!parsed.ok){
      alert("JSON invalide : " + parsed.error);
      return;
    }
    // Basic validation
    if(!parsed.value.products || !parsed.value.flows || !parsed.value.rules){
      alert("JSON incomplet : doit contenir products, flows, rules.");
      return;
    }
    CONFIG = parsed.value;
    // keep answers but rerender
    currentIdx = 0;
    rerenderAll(true);
  });

  $("restoreDefaultBtn").addEventListener("click", ()=>{
    CONFIG = structuredClone(DEFAULT_CONFIG);
    ui.configEditor.value = JSON.stringify(DEFAULT_CONFIG, null, 2);
    currentIdx = 0;
    rerenderAll(true);
  });

  // CDC copy/download
  $("copyCdcBtn").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText($("cdcText").value);
      alert("Cahier des charges copi√© ‚úÖ");
    }catch(e){
      alert("Copie impossible (permissions navigateur).");
    }
  });
  $("downloadCdcBtn").addEventListener("click", ()=>{
    const blob = new Blob([$("cdcText").value], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "cahier_des_charges_demo.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  });

  // Export JSON
  $("exportJsonBtn").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(CONFIG, null, 2)], {type:"application/json;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "config_demo_levage.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  });

  // Initial render
  ui.filterCmuVal.textContent = ui.filterCmu.value;
  rerenderAll(true);
}

init();
</script>
</body>
</html>


